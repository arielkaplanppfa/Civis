-- select * from npsp_reporting.fact_campaign
Call npsp_reporting.campaign_datamart();
-- CREATE OR REPLACE PROCEDURE npsp_reporting.campaign_datamart()
-- LANGUAGE plpgsql
-- AS $$
-- DECLARE

-- 	v_inserted_timestamp TIMESTAMP; -- Timestamp used TO INSERT INTO the job_history TABLE.
--     v_watermark TIMESTAMP;
--     v_action_count INT;
--     stg_table_SQL varchar(65535) :='';
--    	mergeSQL varchar(65535) :='';
    
-- BEGIN 
	
-- 	--v_watermark := '1900-01-01 00:00:00.000';
	
	
-- 	INSERT INTO npsp_integration.job_step_history (jobstep, lastrun, runstatus, notes, results, transactionid, recordcount)
--  	VALUES (147::integer,v_inserted_timestamp,'started','Campaign Datamart job has started.',NULL, NULL, NULL);

-- 	-- watermark is the max lastmodified date of the source.
-- 	EXECUTE 'SELECT to_char(MAX(max_last_updated) - INTERVAL ''1 day'',''YYYY-MM-DD HH24:MI:SS'') max_last_updated FROM ppfa_golden.golden_opportunities_npsp gon' INTO v_watermark;
	
-- 	EXECUTE 'DROP TABLE IF EXISTS npsp_staging.stg_fact_campaign';
	
-- 		stg_table_SQL := 'CREATE TABLE npsp_staging.stg_fact_campaign AS
-- 						(WITH stg_opps_camp
-- 						AS
-- 						(
-- 						select source_code
-- 						,min(closedate) first_response_date
-- 						,max(closedate) last_response_date
-- 						,sum(case when gift_type in (''Donation Payment'',''Pledge Payment'')
-- 						then 1
-- 						else 0
-- 						end)total_number_paid
-- 						,sum(case when gift_type in (''Donation Payment'',''Pledge Payment'')
-- 						then amount
-- 						else 0
-- 						end)total_amount_paid
-- 						,sum(case when gift_type in (''Donation Payment'',''Pledge'')
-- 						then 1
-- 						else 0
-- 						end)total_number_pledged
-- 						,sum(case when gift_type in (''Donation Payment'',''Pledge'')
-- 						then amount
-- 						else 0
-- 						end)total_amount_pledged
-- 						from ppfa_golden.golden_opportunities_npsp
-- 						where source_code is not NULL
-- 						and max_last_updated >='''||v_watermark||''' group by source_code
-- 						)
-- 						SELECT a.id
-- 						,current_timestamp::timestamp AS lastmodifieddate
-- 						,(b.total_amount_paid/nullif(b.total_number_paid,0))::decimal(18,2) average_gift_amount__c
-- 						,((a.actualcost/1000) * a.numbersent / nullif(a.numbersent,0))::decimal(18,2) cost_per_contact__c
-- 						,b.first_response_date::date first_response_date__c
-- 						,b.last_response_date::date last_response_date__c
-- 						,nvl(a.numbersent,0) numberofcontacts_rd__c
-- 						,((b.total_amount_paid - a.actualcost)/nullif(a.actualcost,0))::decimal(18,2) roi_rd__c
-- 						,b.total_amount_paid::decimal(18,2) total_amount_paid__c
-- 						,b.total_amount_pledged::decimal(18,2) total_amount_pledged__c
-- 						,b.total_number_paid::integer total_number_paid__c
-- 						,b.total_number_pledged::integer total_number_pledged__c
-- 						,nvl(a.numbersent,0) total_number_solicited__c
-- 						FROM stg_opps_camp b
-- 						LEFT JOIN npsp_sfdc.campaign a
-- 						ON b.source_code = a.name
-- 						WHERE a.id IS NOT null)';
					
-- 	EXECUTE stg_table_SQL;
		
-- 		mergeSQL := 'MERGE INTO npsp_reporting.fact_campaign
-- 		USING npsp_staging.stg_fact_campaign
-- 		ON npsp_reporting.fact_campaign.id = npsp_staging.stg_fact_campaign.id
-- 		WHEN MATCHED THEN
-- 		UPDATE SET
-- 				lastmodifieddate = npsp_staging.stg_fact_campaign.lastmodifieddate,
-- 				average_gift_amount__c = npsp_staging.stg_fact_campaign.average_gift_amount__c,
-- 				cost_per_contact__c = npsp_staging.stg_fact_campaign.cost_per_contact__c,
-- 				first_response_date__c = npsp_staging.stg_fact_campaign.first_response_date__c,
-- 				last_response_date__c = npsp_staging.stg_fact_campaign.last_response_date__c,
-- 				numberofcontacts_rd__c = npsp_staging.stg_fact_campaign.numberofcontacts_rd__c,
-- 				roi_rd__c = npsp_staging.stg_fact_campaign.roi_rd__c,
-- 				total_amount_paid__c = npsp_staging.stg_fact_campaign.total_amount_paid__c,
-- 				total_amount_pledged__c = npsp_staging.stg_fact_campaign.total_amount_pledged__c,
-- 				total_number_paid__c = npsp_staging.stg_fact_campaign.total_number_paid__c,
-- 				total_number_pledged__c = npsp_staging.stg_fact_campaign.total_number_pledged__c,
-- 				total_number_solicited__c = npsp_staging.stg_fact_campaign.total_number_solicited__c
				
-- 		WHEN NOT MATCHED THEN 
-- 			INSERT (
-- 				Id,
-- 				LastModifiedDate,
-- 				Average_Gift_Amount__c,
-- 				Cost_Per_Contact__c,
-- 				First_Response_Date__c,
-- 				Last_Response_Date__c,
-- 				NumberofContacts_RD__c,
-- 				ROI_RD__c,
-- 				Total_Amount_Paid__c,
-- 				Total_Amount_Pledged__c,
-- 				Total_Number_Paid__c,
-- 				Total_Number_Pledged__c,
-- 				Total_Number_Solicited__c
			
-- 				)
-- 				VALUES (npsp_staging.stg_fact_campaign.Id,
-- 				npsp_staging.stg_fact_campaign.LastModifiedDate,
-- 				npsp_staging.stg_fact_campaign.Average_Gift_Amount__c,
-- 				npsp_staging.stg_fact_campaign.Cost_Per_Contact__c,
-- 				npsp_staging.stg_fact_campaign.First_Response_Date__c,
-- 				npsp_staging.stg_fact_campaign.Last_Response_Date__c,
-- 				npsp_staging.stg_fact_campaign.NumberofContacts_RD__c,
-- 				npsp_staging.stg_fact_campaign.ROI_RD__c,
-- 				npsp_staging.stg_fact_campaign.Total_Amount_Paid__c,
-- 				npsp_staging.stg_fact_campaign.Total_Amount_Pledged__c,
-- 				npsp_staging.stg_fact_campaign.Total_Number_Paid__c,
-- 				npsp_staging.stg_fact_campaign.Total_Number_Pledged__c,
-- 				npsp_staging.stg_fact_campaign.Total_Number_Solicited__c)';
	
-- 	EXECUTE mergeSQL;
-- 	GET DIAGNOSTICS v_action_count = ROW_COUNT; 
		
--  	UPDATE npsp_integration.job_step_history 
--  	SET runstatus = 'complete',
--  		lastrun = CURRENT_TIMESTAMP,
--  		results  = 'Updated ROWCOUNT: '|| v_action_count::INT,
--  		recordcount = v_action_count::INT
--  	WHERE lastrun = v_inserted_timestamp AND jobstep = 147::integer;
 
 
-- EXCEPTION WHEN OTHERS THEN 
--  	-- Log the error
--  	RAISE INFO 'An exception occurred.';
--  	UPDATE npsp_integration.job_step_history
--  	SET runstatus = 'failed',
--  		lastrun = CURRENT_TIMESTAMP,
--  		notes = 'Error message: '|| SQLERRM 
--  	WHERE lastrun = v_inserted_timestamp AND jobstep = 147::integer;		
-- END;
-- $$;