-- select count(*) from npsp_reporting.fact_giving_summary;
CALL npsp_reporting.giving_summary_job();
/* Developer: Colin Prosser
 * JIRA_URL: https://plannedparenthood.atlassian.net/browse/DS-172
 * Logic: Create and update giving summaries by account.
 * Notes:
 * Date: 10/5/2023
 * 
 * */


-- CREATE OR REPLACE PROCEDURE npsp_reporting.giving_summary_job() 
-- LANGUAGE plpgsql
-- AS $$
-- DECLARE 
    
--     v_inserted_timestamp TIMESTAMP; -- Timestamp used TO INSERT INTO the job_history TABLE.
--     v_watermark TIMESTAMP;
    
   	
-- 	sqlCols VARCHAR(20000) := '';
--     sqlWhere VARCHAR(20000) := '';
--     dropSQL VARCHAR(65535) := '';
--     mvSQL VARCHAR(65535) := '';
--    	mergeSQL VARCHAR(65535) := '';
--     currentCategoryType VARCHAR(100);
--    	table_name VARCHAR(1000);
--     query_string VARCHAR(65535) := '';
    
--     first BOOLEAN := true;
--     is_valid BOOLEAN;
    
--     table_cur REFCURSOR;
--     drop_cur REFCURSOR;
--     mv_cur REFCURSOR;
--     col_cur REFCURSOR;
--    	cur REFCURSOR;

--     v_action_count INT;
--     v_error_message VARCHAR(20000) :='';
--     v_job_history_id VARCHAR(18) :='';

-- BEGIN
	
-- 	-- Inserts a row into the job history table with the status = started

-- 		v_inserted_timestamp := CURRENT_TIMESTAMP;
-- 		v_watermark = '1900-01-01 00:00:000';
		
-- --INSERT INTO npsp_integration.job_history (jobid, lastrun, runstatus, notes)
-- --VALUES (13::INTEGER,v_inserted_timestamp,'started','Civis Aggregation Workflow has started.');
		
	
-- 	-- watermark is the max lastmodified date of the source.
-- 	EXECUTE 'SELECT max(max_last_updated) max_last_updated FROM ppfa_golden.golden_opportunities_npsp gon' INTO v_watermark;			
		
-- 	    -- Drop the fact giving summary staging table
-- 	EXECUTE 'DROP TABLE IF EXISTS npsp_staging.stg_fact_giving_summary cascade';
		
	
--     	-- Open a cursor to fetch column names the giving summary code table
-- 	sqlCols := (select listagg(t.one,', ') from (SELECT replace(calculation, chr(10), chr(32))||' as '|| column_name as one 
-- 	    FROM mss.npsp_giving_summary_code 
-- 	    WHERE calculation_type like '%giving_summary%' 
-- 	    AND column_name NOT IN ('ID','CREATEDBYID','LASTMODIFIEDDATE','LASTMODIFIEDBYID','SYSTEMMODSTAMP','TYPE'))t);
	
	    
		
-- 	    -- Cursor to hold giving summary categories
-- 	  OPEN drop_cur FOR SELECT giving_summary_type FROM npsp_reporting.dim_giving_summary_type;
	
-- 	    -- Loops through a list of giving summary type names in the cursor to drop the materialized views
-- 	  LOOP
	        
-- 	      FETCH drop_cur INTO currentCategoryType;
	        
-- 	      EXIT WHEN NOT FOUND;
	        
-- 		-- Construct the final SQL statement to insert into the aggregated table
-- 		dropSQL := 'DROP VIEW IF EXISTS npsp_reporting.v_'||currentCategoryType;
			
-- 	        -- Execute the constructed SQL
-- 	   		EXECUTE dropSQL;
-- 	    END LOOP;
	    
-- 	    CLOSE drop_cur;
   
--     -- Open a cursor to loop through each category type and giving summary logic, then creates materialzed views for analysis or troubleshooting.
--     OPEN mv_cur FOR SELECT giving_summary_type, giving_summary_logic FROM npsp_reporting.dim_giving_summary_type;

--     LOOP
        
--         FETCH mv_cur INTO currentCategoryType, sqlWhere;
                
--         EXIT WHEN NOT FOUND;
        
--         -- Construct the final SQL statement to insert into the aggregated table
--         mvSQL := 'CREATE OR REPLACE VIEW npsp_reporting.v_' || currentCategoryType || ' AS (SELECT coalesce(q2.accountid,NULL::VARCHAR(18)) AS giving_summary_id, q1.npsp_accountid || ''_'' || ''' || currentCategoryType || ''' AS gs_unique_identifier, ''' || currentCategoryType || ''' as giving_summary_type, ' || sqlCols || ', current_timestamp AS last_modified_date FROM ppfa_golden.golden_opportunities_npsp q1 LEFT JOIN npsp_sfdc.giving_summaries_v q2 ON q1.npsp_accountid = q2.accountid LEFT JOIN npsp_reporting.v_summary_omits q3 on q1.npsp_accountid = q3.accountid ' ||
-- 			sqlWhere ||' AND q1.max_last_updated >= ''' ||v_watermark ||''' GROUP BY npsp_accountid,q2.accountid)';
       
-- 		-- Execute the constructed SQL
--         EXECUTE mvSQL;
--     END LOOP;

--     CLOSE mv_cur;
   	
--    	-- This cursor gets the where clause from the dimenion table, dim_giving_summary, based on the giving summary type.
--    	OPEN table_cur FOR SELECT 'npsp_reporting.v_'||lower(giving_summary_type) FROM npsp_reporting.dim_giving_summary_type;
    
--     LOOP
--         FETCH table_cur INTO table_name;
        
--         EXIT WHEN NOT FOUND;
--          --IF is_valid THEN
--             IF first THEN
--                 query_string := 'SELECT * FROM ' || table_name;
--                 first := false;
--             ELSE
--                 query_string := query_string || ' UNION ALL SELECT * FROM ' || table_name;
--             END IF;
--         --END IF;
--     END LOOP;
    
--     CLOSE table_cur;
    
-- 	-- Recreates the fact giving summary staging table with the deltas, by unioning the materialized views created previously.
--      query_string := 'CREATE TABLE npsp_staging.stg_fact_giving_summary AS ' || query_string;
    
-- 	EXECUTE query_string;

-- 	-- Add accountid as the distribution key of the staging fact table.
-- 	EXECUTE 'ALTER TABLE npsp_staging.stg_fact_giving_summary ALTER DISTKEY accountid';
--     -- If you just want to check the query string
--     --RAISE INFO 'Generated Query: %', query_string;
   	
-- 	-- Merge statement that will be used to UPDATE and INSERT new records in the fact_giving_summary table.
--  		MERGESQL := 'MERGE INTO NPSP_REPORTING.FACT_GIVING_SUMMARY
-- 						USING NPSP_STAGING.STG_FACT_GIVING_SUMMARY
-- 						ON NPSP_REPORTING.FACT_GIVING_SUMMARY.GS_UNIQUE_IDENTIFIER = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.GS_UNIQUE_IDENTIFIER
-- 					WHEN MATCHED THEN
-- 						UPDATE SET
-- 						GIVING_SUMMARY_ID = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.GIVING_SUMMARY_ID,
-- 						--GS_UNIQUE_IDENTIFIER = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.GS_UNIQUE_IDENTIFIER,
-- 						GIVING_SUMMARY_TYPE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.GIVING_SUMMARY_TYPE,
-- 						C3_CURRENT_CALENDAR_YEAR_GIVING_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_CURRENT_CALENDAR_YEAR_GIVING_AMOUNT,
-- 						C3_LAST_CALENDAR_YEAR_GIVING = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LAST_CALENDAR_YEAR_GIVING,
-- 						C3_SECOND_CALENDAR_YEAR_GIVING = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_SECOND_CALENDAR_YEAR_GIVING,
-- 						C3_THIRD_CALENDAR_YEAR_GIVING = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_THIRD_CALENDAR_YEAR_GIVING,
-- 						C3_FOURTH_CALENDAR_YEAR_GIVING = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_FOURTH_CALENDAR_YEAR_GIVING,
-- 						C3_FIRST_GIFT_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_FIRST_GIFT_AMOUNT,
-- 						C3_FIRST_GIFT_DATE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_FIRST_GIFT_DATE,
-- 						C3_FIRST_GIFT_ID = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_FIRST_GIFT_ID,
-- 						C3_FIRST_GIFT_SOURCE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_FIRST_GIFT_SOURCE,
-- 						C3_LARGEST_GIFT_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LARGEST_GIFT_AMOUNT,
-- 						C3_LARGEST_GIFT_DATE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LARGEST_GIFT_DATE,
-- 						C3_LARGEST_GIFT_ID = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LARGEST_GIFT_ID,
-- 						C3_LARGEST_GIFT_SOURCE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LARGEST_GIFT_SOURCE,
-- 						C3_LAST_GIFT_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LAST_GIFT_AMOUNT,
-- 						C3_LAST_GIFT_DATE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LAST_GIFT_DATE,
-- 						C3_LAST_GIFT_ID = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LAST_GIFT_ID,
-- 						C3_LAST_GIFT_SOURCE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LAST_GIFT_SOURCE,
-- 						C3_LARGEST_RECENT_GIFT_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LARGEST_RECENT_GIFT_AMOUNT,
-- 						C3_LARGEST_RECENT_GIFT_DATE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LARGEST_RECENT_GIFT_DATE,
-- 						C3_LARGEST_RECENT_GIFT_ID = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LARGEST_RECENT_GIFT_ID,
-- 						C3_LARGEST_RECENT_GIFT_SOURCE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LARGEST_RECENT_GIFT_SOURCE,
-- 						C3_LIFETIME_GIVING_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LIFETIME_GIVING_AMOUNT,
-- 						C3_LIFETIME_GIVING_COUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LIFETIME_GIVING_COUNT,
-- 						C4_CURRENT_CALENDAR_YEAR_GIVING = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_CURRENT_CALENDAR_YEAR_GIVING,
-- 						C4_LAST_CALENDAR_YEAR_GIVING = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LAST_CALENDAR_YEAR_GIVING,
-- 						C4_SECOND_CALENDAR_YEAR_GIVING = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_SECOND_CALENDAR_YEAR_GIVING,
-- 						C4_THIRD_CALENDAR_YEAR_GIVING = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_THIRD_CALENDAR_YEAR_GIVING,
-- 						C4_FOURTH_CALENDAR_YEAR_GIVING = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_FOURTH_CALENDAR_YEAR_GIVING,
-- 						C4_FIRST_GIFT_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_FIRST_GIFT_AMOUNT,
-- 						C4_FIRST_GIFT_DATE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_FIRST_GIFT_DATE,
-- 						C4_FIRST_GIFT_ID = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_FIRST_GIFT_ID,
-- 						C4_FIRST_GIFT_SOURCE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_FIRST_GIFT_SOURCE,
-- 						C4_LARGEST_GIFT_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LARGEST_GIFT_AMOUNT,
-- 						C4_LARGEST_GIFT_DATE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LARGEST_GIFT_DATE,
-- 						C4_LARGEST_GIFT_ID = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LARGEST_GIFT_ID,
-- 						C4_LARGEST_GIFT_SOURCE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LARGEST_GIFT_SOURCE,
-- 						C4_LAST_GIFT_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LAST_GIFT_AMOUNT,
-- 						C4_LAST_GIFT_DATE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LAST_GIFT_DATE,
-- 						C4_LAST_GIFT_ID = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LAST_GIFT_ID,
-- 						C4_LAST_GIFT_SOURCE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LAST_GIFT_SOURCE,
-- 						C4_LARGEST_RECENT_GIFT_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LARGEST_RECENT_GIFT_AMOUNT,
-- 						C4_LARGEST_RECENT_GIFT_DATE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LARGEST_RECENT_GIFT_DATE,
-- 						C4_LARGEST_RECENT_GIFT_ID = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LARGEST_RECENT_GIFT_ID,
-- 						C4_LARGEST_RECENT_GIFT_SOURCE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LARGEST_RECENT_GIFT_SOURCE,
-- 						C4_LIFETIME_GIVING_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LIFETIME_GIVING_AMOUNT,
-- 						C4_LIFETIME_GIVING_COUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LIFETIME_GIVING_COUNT,
-- 						CURRENT_CALENDAR_YEAR_GIVING_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.CURRENT_CALENDAR_YEAR_GIVING_AMOUNT,
-- 						DATE_INSERTED = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.DATE_INSERTED,
-- 						FIRST_GIFT_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.FIRST_GIFT_AMOUNT,
-- 						FIRST_GIFT_DATE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.FIRST_GIFT_DATE,
-- 						FIRST_GIFT_ID = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.FIRST_GIFT_ID,
-- 						FIRST_GIFT_SOURCE_CODE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.FIRST_GIFT_SOURCE_CODE,
-- 						LARGEST_GIFT_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LARGEST_GIFT_AMOUNT,
-- 						LARGEST_GIFT_DATE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LARGEST_GIFT_DATE,
-- 						LARGEST_GIFT_ID = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LARGEST_GIFT_ID,
-- 						LARGEST_GIFT_SOURCE_CODE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LARGEST_GIFT_SOURCE_CODE,
-- 						LAST_CALENDAR_YEAR_GIVING_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LAST_CALENDAR_YEAR_GIVING_AMOUNT,
-- 						LAST_GIFT_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LAST_GIFT_AMOUNT,
-- 						LAST_GIFT_DATE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LAST_GIFT_DATE,
-- 						LAST_GIFT_ID = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LAST_GIFT_ID,
-- 						LAST_GIFT_SOURCE_CODE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LAST_GIFT_SOURCE_CODE,
-- 						LARGEST_RECENT_GIFT_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LARGEST_RECENT_GIFT_AMOUNT,
-- 						LARGEST_RECENT_GIFT_DATE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LARGEST_RECENT_GIFT_DATE,
-- 						LARGEST_RECENT_GIFT_ID = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LARGEST_RECENT_GIFT_ID,
-- 						LARGEST_RECENT_GIFT_SOURCE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LARGEST_RECENT_GIFT_SOURCE,
-- 						LIFETIME_GIVING_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LIFETIME_GIVING_AMOUNT,
-- 						LIFETIME_PAC_GIVING_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LIFETIME_PAC_GIVING_AMOUNT,
-- 						LIFETIME_PAC_GIVING_COUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LIFETIME_PAC_GIVING_COUNT,
-- 						PAC_CURRENT_CALENDAR_YEAR_GIVING = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.PAC_CURRENT_CALENDAR_YEAR_GIVING,
-- 						PAC_LAST_CALENDAR_YEAR_GIVING = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.PAC_LAST_CALENDAR_YEAR_GIVING,
-- 						PAC_SECOND_CALENDAR_YEAR_GIVING = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.PAC_SECOND_CALENDAR_YEAR_GIVING,
-- 						PAC_THIRD_CALENDAR_YEAR_GIVING = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.PAC_THIRD_CALENDAR_YEAR_GIVING,
-- 						PAC_FOURTH_CALENDAR_YEAR_GIVING = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.PAC_FOURTH_CALENDAR_YEAR_GIVING,
-- 						LIFETIME_GIVING_COUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LIFETIME_GIVING_COUNT,
-- 						SECOND_CALENDAR_YEAR_GIVING_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.SECOND_CALENDAR_YEAR_GIVING_AMOUNT,
-- 						THIRD_CALENDAR_YEAR_GIVING_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.THIRD_CALENDAR_YEAR_GIVING_AMOUNT,
-- 						FOURTH_CALENDAR_YEAR_GIVING_AMOUNT = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.FOURTH_CALENDAR_YEAR_GIVING_AMOUNT,
-- 						LAST_MODIFIED_DATE = NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LAST_MODIFIED_DATE
						
-- 						WHEN NOT MATCHED THEN
-- 							INSERT (
-- 								GIVING_SUMMARY_ID,
-- 								GS_UNIQUE_IDENTIFIER,
-- 								GIVING_SUMMARY_TYPE,
-- 								ACCOUNTID,
-- 								C3_CURRENT_CALENDAR_YEAR_GIVING_AMOUNT,
-- 								C3_LAST_CALENDAR_YEAR_GIVING,
-- 								C3_SECOND_CALENDAR_YEAR_GIVING,
-- 								C3_THIRD_CALENDAR_YEAR_GIVING,
-- 								C3_FOURTH_CALENDAR_YEAR_GIVING,
-- 								C3_FIRST_GIFT_AMOUNT,
-- 								C3_FIRST_GIFT_DATE,
-- 								C3_FIRST_GIFT_ID,
-- 								C3_FIRST_GIFT_SOURCE,
-- 								C3_LARGEST_GIFT_AMOUNT,
-- 								C3_LARGEST_GIFT_DATE,
-- 								C3_LARGEST_GIFT_ID,
-- 								C3_LARGEST_GIFT_SOURCE,
-- 								C3_LAST_GIFT_AMOUNT,
-- 								C3_LAST_GIFT_DATE,
-- 								C3_LAST_GIFT_ID,
-- 								C3_LAST_GIFT_SOURCE,
-- 								C3_LARGEST_RECENT_GIFT_AMOUNT,
-- 								C3_LARGEST_RECENT_GIFT_DATE,
-- 								C3_LARGEST_RECENT_GIFT_ID,
-- 								C3_LARGEST_RECENT_GIFT_SOURCE,
-- 								C3_LIFETIME_GIVING_AMOUNT,
-- 								C3_LIFETIME_GIVING_COUNT,
-- 								C4_CURRENT_CALENDAR_YEAR_GIVING,
-- 								C4_LAST_CALENDAR_YEAR_GIVING,
-- 								C4_SECOND_CALENDAR_YEAR_GIVING,
-- 								C4_THIRD_CALENDAR_YEAR_GIVING,
-- 								C4_FOURTH_CALENDAR_YEAR_GIVING,
-- 								C4_FIRST_GIFT_AMOUNT,
-- 								C4_FIRST_GIFT_DATE,
-- 								C4_FIRST_GIFT_ID,
-- 								C4_FIRST_GIFT_SOURCE,
-- 								C4_LARGEST_GIFT_AMOUNT,
-- 								C4_LARGEST_GIFT_DATE,
-- 								C4_LARGEST_GIFT_ID,
-- 								C4_LARGEST_GIFT_SOURCE,
-- 								C4_LAST_GIFT_AMOUNT,
-- 								C4_LAST_GIFT_DATE,
-- 								C4_LAST_GIFT_ID,
-- 								C4_LAST_GIFT_SOURCE,
-- 								C4_LARGEST_RECENT_GIFT_AMOUNT,
-- 								C4_LARGEST_RECENT_GIFT_DATE,
-- 								C4_LARGEST_RECENT_GIFT_ID,
-- 								C4_LARGEST_RECENT_GIFT_SOURCE,
-- 								C4_LIFETIME_GIVING_AMOUNT,
-- 								C4_LIFETIME_GIVING_COUNT,
-- 								CURRENT_CALENDAR_YEAR_GIVING_AMOUNT,
-- 								DATE_INSERTED,
-- 								FIRST_GIFT_AMOUNT,
-- 								FIRST_GIFT_DATE,
-- 								FIRST_GIFT_ID,
-- 								FIRST_GIFT_SOURCE_CODE,
-- 								LARGEST_GIFT_AMOUNT,
-- 								LARGEST_GIFT_DATE,
-- 								LARGEST_GIFT_ID,
-- 								LARGEST_GIFT_SOURCE_CODE,
-- 								LAST_CALENDAR_YEAR_GIVING_AMOUNT,
-- 								LAST_GIFT_AMOUNT,
-- 								LAST_GIFT_DATE,
-- 								LAST_GIFT_ID,
-- 								LAST_GIFT_SOURCE_CODE,
-- 								LARGEST_RECENT_GIFT_AMOUNT,
-- 								LARGEST_RECENT_GIFT_DATE,
-- 								LARGEST_RECENT_GIFT_ID,
-- 								LARGEST_RECENT_GIFT_SOURCE,
-- 								LIFETIME_GIVING_AMOUNT,
-- 								LIFETIME_PAC_GIVING_AMOUNT,
-- 								LIFETIME_PAC_GIVING_COUNT,
-- 								PAC_CURRENT_CALENDAR_YEAR_GIVING,
-- 								PAC_LAST_CALENDAR_YEAR_GIVING,
-- 								PAC_SECOND_CALENDAR_YEAR_GIVING,
-- 								PAC_THIRD_CALENDAR_YEAR_GIVING,
-- 								PAC_FOURTH_CALENDAR_YEAR_GIVING,
-- 								LIFETIME_GIVING_COUNT,
-- 								SECOND_CALENDAR_YEAR_GIVING_AMOUNT,
-- 								THIRD_CALENDAR_YEAR_GIVING_AMOUNT,
-- 								FOURTH_CALENDAR_YEAR_GIVING_AMOUNT,
-- 								LAST_MODIFIED_DATE)
-- 								VALUES (NPSP_STAGING.STG_FACT_GIVING_SUMMARY.GIVING_SUMMARY_ID,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.GS_UNIQUE_IDENTIFIER,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.GIVING_SUMMARY_TYPE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.ACCOUNTID,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_CURRENT_CALENDAR_YEAR_GIVING_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LAST_CALENDAR_YEAR_GIVING,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_SECOND_CALENDAR_YEAR_GIVING,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_THIRD_CALENDAR_YEAR_GIVING,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_FOURTH_CALENDAR_YEAR_GIVING,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_FIRST_GIFT_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_FIRST_GIFT_DATE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_FIRST_GIFT_ID,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_FIRST_GIFT_SOURCE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LARGEST_GIFT_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LARGEST_GIFT_DATE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LARGEST_GIFT_ID,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LARGEST_GIFT_SOURCE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LAST_GIFT_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LAST_GIFT_DATE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LAST_GIFT_ID,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LAST_GIFT_SOURCE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LARGEST_RECENT_GIFT_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LARGEST_RECENT_GIFT_DATE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LARGEST_RECENT_GIFT_ID,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LARGEST_RECENT_GIFT_SOURCE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LIFETIME_GIVING_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C3_LIFETIME_GIVING_COUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_CURRENT_CALENDAR_YEAR_GIVING,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LAST_CALENDAR_YEAR_GIVING,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_SECOND_CALENDAR_YEAR_GIVING,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_THIRD_CALENDAR_YEAR_GIVING,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_FOURTH_CALENDAR_YEAR_GIVING,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_FIRST_GIFT_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_FIRST_GIFT_DATE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_FIRST_GIFT_ID,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_FIRST_GIFT_SOURCE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LARGEST_GIFT_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LARGEST_GIFT_DATE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LARGEST_GIFT_ID,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LARGEST_GIFT_SOURCE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LAST_GIFT_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LAST_GIFT_DATE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LAST_GIFT_ID,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LAST_GIFT_SOURCE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LARGEST_RECENT_GIFT_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LARGEST_RECENT_GIFT_DATE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LARGEST_RECENT_GIFT_ID,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LARGEST_RECENT_GIFT_SOURCE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LIFETIME_GIVING_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.C4_LIFETIME_GIVING_COUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.CURRENT_CALENDAR_YEAR_GIVING_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.DATE_INSERTED,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.FIRST_GIFT_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.FIRST_GIFT_DATE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.FIRST_GIFT_ID,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.FIRST_GIFT_SOURCE_CODE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LARGEST_GIFT_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LARGEST_GIFT_DATE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LARGEST_GIFT_ID,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LARGEST_GIFT_SOURCE_CODE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LAST_CALENDAR_YEAR_GIVING_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LAST_GIFT_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LAST_GIFT_DATE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LAST_GIFT_ID,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LAST_GIFT_SOURCE_CODE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LARGEST_RECENT_GIFT_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LARGEST_RECENT_GIFT_DATE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LARGEST_RECENT_GIFT_ID,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LARGEST_RECENT_GIFT_SOURCE,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LIFETIME_GIVING_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LIFETIME_PAC_GIVING_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LIFETIME_PAC_GIVING_COUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.PAC_CURRENT_CALENDAR_YEAR_GIVING,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.PAC_LAST_CALENDAR_YEAR_GIVING,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.PAC_SECOND_CALENDAR_YEAR_GIVING,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.PAC_THIRD_CALENDAR_YEAR_GIVING,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.PAC_FOURTH_CALENDAR_YEAR_GIVING,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LIFETIME_GIVING_COUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.SECOND_CALENDAR_YEAR_GIVING_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.THIRD_CALENDAR_YEAR_GIVING_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.FOURTH_CALENDAR_YEAR_GIVING_AMOUNT,
-- 								NPSP_STAGING.STG_FACT_GIVING_SUMMARY.LAST_MODIFIED_DATE)';

   	
-- 	EXECUTE mergeSQL;

   	
-- 	GET DIAGNOSTICS v_action_count = ROW_COUNT; 
		
-- 	UPDATE npsp_integration.job_history_test 
-- 	SET runstatus = 'complete',
-- 		lastrun = CURRENT_TIMESTAMP,
-- 		notes = 'Updated ROWCOUNT: '|| v_action_count::INT
-- 	WHERE lastrun = v_inserted_timestamp;

-- 	UPDATE npsp_integration.civis_etl_metadata 
--         SET low_watermark = v_high_watermark, 
--             high_watermark = NULL, 
--             last_updated = CURRENT_TIMESTAMP 
--     WHERE jobid = 13;

-- EXCEPTION WHEN OTHERS THEN 
-- 	-- Log the error
-- 	RAISE INFO 'An exception occurred.';
-- 	UPDATE npsp_integration.job_history
-- 	SET runstatus = 'failed',
-- 		lastrun = CURRENT_TIMESTAMP,
-- 		notes = 'Error message: '|| SQLERRM 
-- 	WHERE lastrun = v_inserted_timestamp;

   
-- END;
-- $$;