-- TRUNCATE npsp_reporting.fact_giving_summary ;
-- TRUNCATE npsp_staging.stg_fact_giving_summary;

-- select count(*) from npsp_reporting.fact_giving_summary;
CALL npsp_reporting.giving_summary_job();
/* Developer: Colin Prosser
 * JIRA_URL: https://plannedparenthood.atlassian.net/browse/DS-172
 * Logic: Create and update giving summaries by account.
 * Notes:
 * Date: 10/5/2023
 * 
 * */



--  CREATE OR REPLACE PROCEDURE npsp_reporting.giving_summary_job() 
--    LANGUAGE plpgsql
--    AS $$
--    DECLARE 
   
--        v_inserted_timestamp TIMESTAMP; -- Timestamp used TO INSERT INTO the job_history TABLE.
--        v_watermark TIMESTAMP;
   
--        sql_accountids VARCHAR(65535) := '';
--    	  sqlCols VARCHAR(20000) := '';
--        sqlWhere VARCHAR(20000) := '';
--        dropSQL VARCHAR(65535) := '';
--        mvSQL VARCHAR(65535) := '';
--        mergeSQL VARCHAR(65535) := '';
--        all_givingSQL VARCHAR(65535) := '';
--        currentCategoryType VARCHAR(100);
--        table_name VARCHAR(1000);
--        query_string VARCHAR(65535) := '';
--        query_all_data VARCHAR(65535) := '';
--        stg_fact_giving_summarySQL VARCHAR(65535) := '';
   
--        first BOOLEAN := true;
--        is_valid BOOLEAN;
   
--        table_cur REFCURSOR;
--        drop_cur REFCURSOR;
--        mv_cur REFCURSOR;
--        col_cur REFCURSOR;
--        cur REFCURSOR;
--      -- sqlAccountIds REFCURSOR;
	
--        v_action_count INT;
--        v_error_message VARCHAR(20000) :='';
--        v_job_history_id VARCHAR(18) :='';

--    BEGIN
		
--  	  	-- Inserts a row into the job history table with the status = started
	
--  	  		v_inserted_timestamp := CURRENT_TIMESTAMP;
-- 			--v_watermark = '2024-01-01 00:00:00.000';
			
--  	 	-- INSERT INTO npsp_integration.job_step_history (jobstep, lastrun, runstatus, notes, results, transactionid, recordcount)
--  	  	-- VALUES (143::integer,v_inserted_timestamp,'started','Giving Summary job has started.',NULL, NULL, NULL);
	

		
--  	  	-- watermark is the max max(last_updated_date) of the source.
--  	  	EXECUTE 'SELECT to_char(MAX(npsp_reporting.subtract_7_days(max_last_updated)),''YYYY-MM-DD HH24:MI:SS'') max_last_updated FROM ppfa_golden.golden_opportunities_npsp gon' INTO v_watermark;		
 	  
--  	  	--EXECUTE 'SELECT to_char(MAX(max_last_updated),''YYYY-MM-DD HH24:MI:SS'') max_last_updated FROM ppfa_golden.golden_opportunities_npsp gon' INTO v_watermark;
			
--  	  	    -- Drop the fact giving summary staging table
--  	  	--EXECUTE 'DROP TABLE if exists npsp_staging.stg_fact_giving_summary';
--  	  	EXECUTE 'DROP TABLE if exists npsp_staging.stg_all_giving';
	  
		
						
--  	      	-- Open a cursor to fetch column names the giving summary code table
--  	   	sqlCols := (select listagg(t.one,', ') from (SELECT replace(calculation, chr(10), chr(32))||' as '|| column_name as one 
--  	   	    FROM npsp_reporting.npsp_giving_summary_code 
--  	   	    WHERE calculation_type like '%giving_summary%' AND column_name NOT IN ('ID','CREATEDBYID','LASTMODIFIEDDATE','LASTMODIFIEDBYID','SYSTEMMODSTAMP','TYPE'))
--  	   	   t);
		
		  
			
--  	  	    -- Cursor to hold giving summary categories
--  	  	  OPEN drop_cur FOR SELECT giving_summary_type FROM npsp_reporting.dim_giving_summary_type;
		
--  	  	    -- Loops through a list of giving summary type names in the cursor to drop the materialized views
--  	  	  LOOP
		        
--  	  	      FETCH drop_cur INTO currentCategoryType;
		        
--  	  	      EXIT WHEN NOT FOUND;
		        
--  	  		-- Construct the final SQL statement to insert into the aggregated table
--  	  		dropSQL := 'DROP TABLE IF EXISTS npsp_staging.stg_'||currentCategoryType;
				
--  	  	        -- Execute the constructed SQL
--  	  	   		EXECUTE dropSQL;
--  	  	    END LOOP;
		    
--  	  	    CLOSE drop_cur;
	   
--  	      -- Open a cursor to loop through each category type and giving summary logic, then creates materialzed views for analysis or troubleshooting.
--  	      OPEN mv_cur FOR SELECT giving_summary_type, giving_summary_logic FROM npsp_reporting.dim_giving_summary_type;
	
--  	      LOOP
	        
--  	          FETCH mv_cur INTO currentCategoryType, sqlWhere;
	                
--  	          EXIT WHEN NOT FOUND;
	        
--  	          -- Construct the final SQL statement to insert into the aggregated table
--  	           mvSQL := 'CREATE TABLE npsp_staging.stg_' || currentCategoryType || ' AS (select ''' || currentCategoryType || ''' as giving_summary_type, ' || sqlCols || ', current_timestamp::timestamp AS last_modified_date FROM ppfa_golden.golden_opportunities_npsp q1 
--  	 			 ' ||sqlWhere ||' and max_last_updated >='''||v_watermark ||''' GROUP BY q1.npsp_accountid)';
	       
--  	  		-- Execute the constructed SQL
--  	          EXECUTE mvSQL;
--  	      END LOOP;
	
--  	      CLOSE mv_cur;
	   	
--  	     	-- This cursor gets the where clause from the dimenion table, dim_giving_summary, based on the giving summary type.
--  	     	OPEN table_cur FOR SELECT 'npsp_staging.stg_'||lower(giving_summary_type) FROM npsp_reporting.dim_giving_summary_type;
	    
--  	      LOOP
--  	          FETCH table_cur INTO table_name;
	        
--  	          EXIT WHEN NOT FOUND;
--  	           --IF is_valid THEN
--  	              IF first THEN
--  	                  query_string := 'SELECT * FROM ' || table_name;
--  	                  first := false;
--  	              ELSE
--  	                  query_string := query_string || ' UNION ALL SELECT * FROM ' || table_name;
--  	              END IF;
--  	          --END IF;
--  	      END LOOP;
	      
--  	     CLOSE table_cur;
	    
--  	  	-- Recreates the fact giving summary staging table with the deltas, by unioning the materialized views created previously.
--  	       query_all_data := 'CREATE TABLE npsp_staging.stg_all_giving AS ' || query_string;
	    
--  	  		EXECUTE query_all_data;
	  	
--  	  		--CREATE TABLE  npsp_staging.stg_giving_summary (LIKE npsp_reporting.fact_giving_summary)
--  	  		--ALTER TABLE npsp_staging.stg_giving_summary RENAME COLUMN giving_summary_external_id TO giving_summary_external_id__c;

--  	  		EXECUTE 'TRUNCATE TABLE npsp_staging.stg_giving_summary';
	  	
--  			  all_givingSQL :=	'INSERT INTO  npsp_staging.stg_giving_summary
-- 										 	SELECT
-- 											NULL::VARCHAR(18) AS giving_summary_id,
-- 											cast(fnv_hash(a.giving_summary_type || a.AccountId) as varchar(255)) giving_summary_external_id__c,
-- 											a.giving_summary_type,
-- 											a.accountid,
-- 											a.c3_current_calendar_year_giving_amount,
-- 											a.c3_last_calendar_year_giving,
-- 											a.c3_second_calendar_year_giving,
-- 											a.c3_third_calendar_year_giving,
-- 											a.c3_fourth_calendar_year_giving,
-- 											a.c3_first_gift_amount,
-- 											a.c3_first_gift_date,
-- 											a.c3_first_gift_id,
-- 											a.c3_first_gift_source,
-- 											a.c3_largest_gift_amount,
-- 											a.c3_largest_gift_date, 
-- 											a.c3_largest_gift_id,
-- 											a.c3_largest_gift_source,
-- 											a.c3_last_gift_amount,
-- 											a.c3_last_gift_date,
-- 											a.c3_last_gift_id,
-- 											a.c3_last_gift_source,
-- 											a.c3_largest_recent_gift_amount,
-- 											a.c3_largest_recent_gift_date,
-- 											a.c3_largest_recent_gift_id,
-- 											a.c3_largest_recent_gift_source,
-- 											a.c3_lifetime_giving_amount,
-- 											a.c3_lifetime_giving_count,
-- 											a.c4_current_calendar_year_giving,
-- 											a.c4_last_calendar_year_giving,
-- 											a.c4_second_calendar_year_giving,
-- 											a.c4_third_calendar_year_giving,
-- 											a.c4_fourth_calendar_year_giving,
-- 											a.c4_first_gift_amount,
-- 											a.c4_first_gift_date, 
-- 											a.c4_first_gift_id,
-- 											a.c4_first_gift_source,
-- 											a.c4_largest_gift_amount,
-- 											a.c4_largest_gift_date, 
-- 											a.c4_largest_gift_id,
-- 											a.c4_largest_gift_source,
-- 											a.c4_last_gift_amount,
-- 											a.c4_last_gift_date,
-- 											a.c4_last_gift_id,
-- 											a.c4_last_gift_source,
-- 											a.c4_largest_recent_gift_amount,
-- 											a.c4_largest_recent_gift_date,
-- 											a.c4_largest_recent_gift_id,
-- 											a.c4_largest_recent_gift_source,
-- 											a.c4_lifetime_giving_amount,
-- 											a.c4_lifetime_giving_count,
-- 											a.current_calendar_year_giving_amount,
-- 											a.date_inserted,
-- 											a.first_gift_amount,
-- 											a.first_gift_date, 
-- 											a.first_gift_id,
-- 											a.first_gift_source_code,
-- 											a.largest_gift_amount,
-- 											a.largest_gift_date,
-- 											a.largest_gift_id,
-- 											a.largest_gift_source_code,
-- 											a.last_calendar_year_giving_amount,
-- 											a.last_gift_amount,
-- 											a.last_gift_date,
-- 											a.last_gift_id,
-- 											a.last_gift_source_code,
-- 											a.largest_recent_gift_amount,
-- 											a.largest_recent_gift_date, 
-- 											a.largest_recent_gift_id,
-- 											a.largest_recent_gift_source,
-- 											a.lifetime_giving_amount,
-- 											a.lifetime_pac_giving_amount,
-- 											a.lifetime_pac_giving_count,
-- 											a.pac_current_calendar_year_giving,
-- 											a.pac_last_calendar_year_giving,
-- 											a.pac_second_calendar_year_giving,
-- 											a.pac_third_calendar_year_giving,
-- 											a.pac_fourth_calendar_year_giving,
-- 											a.lifetime_giving_count,
-- 											a.second_calendar_year_giving_amount,
-- 											a.third_calendar_year_giving_amount,
-- 											a.fourth_calendar_year_giving_amount,
-- 											current_timestamp
-- 										FROM
-- 											npsp_staging.stg_all_giving a
-- 										LEFT JOIN npsp_reporting.v_summary_omits b
-- 										 ON	a.accountid = b.accountid
-- 										WHERE b.accountid IS NULL';

		  
--  		  	EXECUTE all_givingSQL;
		  
		
--  		 	EXECUTE 'DROP TABLE IF EXISTS npsp_staging.stg_fact_giving_summary';
		 		
--  			 	stg_fact_giving_summarySQL := ' CREATE TABLE npsp_staging.stg_fact_giving_summary AS
--  												SELECT COALESCE(gs3.id,a.giving_summary_id)giving_summary_id , CAST(a.giving_summary_external_id__c AS varchar(255))giving_summary_external_id__c, a.giving_summary_type type__c, a.accountid, a.c3_current_calendar_year_giving_amount__c, a.c3_last_calendar_year_giving__c, 
--  												a.c3_second_calendar_year_giving__c, a.c3_third_calendar_year_giving__c, a.c3_fourth_calendar_year_giving__c, a.c3_first_gift_amount__c, a.c3_first_gift_date__c, 
--  												a.c3_first_gift_id__c, a.c3_first_gift_source__c, a.c3_largest_gift_amount__c, a.c3_largest_gift_date__c, a.c3_largest_gift_id__c, a.c3_largest_gift_source__c, a.c3_last_gift_amount__c, 
--  												a.c3_last_gift_date__c, a.c3_last_gift_id__c, a.c3_last_gift_source__c, a.c3_largest_recent_gift_amount__c, a.c3_largest_recent_gift_date__c, a.c3_largest_recent_gift_id__c, 
--  												a.c3_largest_recent_gift_source__c, a.c3_lifetime_giving_amount__c, a.c3_lifetime_giving_count__c, a.c4_current_calendar_year_giving__c, a.c4_last_calendar_year_giving__c, 
--  												a.c4_second_calendar_year_giving__c, a.c4_third_calendar_year_giving__c, a.c4_fourth_calendar_year_giving__c, a.c4_first_gift_amount__c, a.c4_first_gift_date__c, 
--  												a.c4_first_gift_id__c, a.c4_first_gift_source__c, a.c4_largest_gift_amount__c, a.c4_largest_gift_date__c, a.c4_largest_gift_id__c, a.c4_largest_gift_source__c, 
--  												a.c4_last_gift_amount__c, a.c4_last_gift_date__c, a.c4_last_gift_id__c, a.c4_last_gift_source__c, a.c4_largest_recent_gift_amount__c, a.c4_largest_recent_gift_date__c, 
--  												a.c4_largest_recent_gift_id__c, a.c4_largest_recent_gift_source__c, a.c4_lifetime_giving_amount__c, a.c4_lifetime_giving_count__c, a.current_calendar_year_giving_amount__c, 
--  												a.date_inserted__c, a.first_gift_amount__c, a.first_gift_date__c, a.first_gift_id__c, a.first_gift_source_code__c, a.largest_gift_amount__c, a.largest_gift_date__c, 
--  												a.largest_gift_id__c, a.largest_gift_source_code__c, a.last_calendar_year_giving_amount__c, a.last_gift_amount__c, a.last_gift_date__c, a.last_gift_id__c, a.last_gift_source_code__c, 
--  												a.largest_recent_gift_amount__c, a.largest_recent_gift_date__c, a.largest_recent_gift_id__c, a.largest_recent_gift_source__c, a.lifetime_giving_amount__c, 
--  												a.lifetime_pac_giving_amount__c, a.lifetime_pac_giving_count__c, a.pac_current_calendar_year_giving__c, a.pac_last_calendar_year_giving__c, 
--  												a.pac_second_calendar_year_giving__c, a.pac_third_calendar_year_giving__c, a.pac_fourth_calendar_year_giving__c, a.lifetime_giving_count__c, 
--  												a.second_calendar_year_giving_amount__c, a.third_calendar_year_giving_amount__c, a.fourth_calendar_year_giving_amount__c, a.last_modified_date::timestamp
--  												FROM npsp_staging.stg_giving_summary a
-- 												LEFT JOIN npsp_sfdc.giving_summaries__c gs3
--  												ON a.giving_summary_external_id__c = gs3.giving_summary_external_id__C AND a.accountid = gs3.accountid__c ';
										
--  			EXECUTE stg_fact_giving_summarySQL;
-- --  					SELECT * FROM npsp_staging.stg_fact_giving_summary sfgs 			
-- --  					SELECT * FROM npsp_reporting.fact_giving_summary fgs 
			
--  			mergeSQL := 'MERGE INTO npsp_reporting.fact_giving_summary
--  						USING npsp_staging.stg_fact_giving_summary  
--  							ON (npsp_reporting.fact_giving_summary.giving_summary_external_id=npsp_staging.stg_fact_giving_summary.giving_summary_external_id__c 
-- 								AND npsp_reporting.fact_giving_summary.accountid = npsp_staging.stg_fact_giving_summary.accountid)
--  						WHEN MATCHED
--  						THEN UPDATE SET
--  							giving_summary_id = npsp_staging.stg_fact_giving_summary.giving_summary_id
--  							,giving_summary_type=npsp_staging.stg_fact_giving_summary.type__c
--  							, accountid=npsp_staging.stg_fact_giving_summary.accountid
--  							, c3_current_calendar_year_giving_amount__c=npsp_staging.stg_fact_giving_summary.c3_current_calendar_year_giving_amount__c
--  							, c3_last_calendar_year_giving__c=npsp_staging.stg_fact_giving_summary.c3_last_calendar_year_giving__c
--  							, c3_second_calendar_year_giving__c=npsp_staging.stg_fact_giving_summary.c3_second_calendar_year_giving__c
--  							, c3_third_calendar_year_giving__c=npsp_staging.stg_fact_giving_summary.c3_third_calendar_year_giving__c
--  							, c3_fourth_calendar_year_giving__c=npsp_staging.stg_fact_giving_summary.c3_fourth_calendar_year_giving__c
--  							, c3_first_gift_amount__c=npsp_staging.stg_fact_giving_summary.c3_first_gift_amount__c
--  							, c3_first_gift_date__c=npsp_staging.stg_fact_giving_summary.c3_first_gift_date__c
--  							, c3_first_gift_id__c=npsp_staging.stg_fact_giving_summary.c3_first_gift_id__c
--  							, c3_first_gift_source__c=npsp_staging.stg_fact_giving_summary.c3_first_gift_source__c
--  							, c3_largest_gift_amount__c=npsp_staging.stg_fact_giving_summary.c3_largest_gift_amount__c
--  							, c3_largest_gift_date__c=npsp_staging.stg_fact_giving_summary.c3_largest_gift_date__c
--  							, c3_largest_gift_id__c=npsp_staging.stg_fact_giving_summary.c3_largest_gift_id__c
--  							, c3_largest_gift_source__c=npsp_staging.stg_fact_giving_summary.c3_largest_gift_source__c
--  							, c3_last_gift_amount__c=npsp_staging.stg_fact_giving_summary.c3_last_gift_amount__c
--  							, c3_last_gift_date__c=npsp_staging.stg_fact_giving_summary.c3_last_gift_date__c
--  							, c3_last_gift_id__c=npsp_staging.stg_fact_giving_summary.c3_last_gift_id__c
--  							, c3_last_gift_source__c=npsp_staging.stg_fact_giving_summary.c3_last_gift_source__c
--  							, c3_largest_recent_gift_amount__c=npsp_staging.stg_fact_giving_summary.c3_largest_recent_gift_amount__c
--  							, c3_largest_recent_gift_date__c=npsp_staging.stg_fact_giving_summary.c3_largest_recent_gift_date__c
--  							, c3_largest_recent_gift_id__c=npsp_staging.stg_fact_giving_summary.c3_largest_recent_gift_id__c
--  							, c3_largest_recent_gift_source__c=npsp_staging.stg_fact_giving_summary.c3_largest_recent_gift_source__c
--  							, c3_lifetime_giving_amount__c=npsp_staging.stg_fact_giving_summary.c3_lifetime_giving_amount__c
--  							, c3_lifetime_giving_count__c=npsp_staging.stg_fact_giving_summary.c3_lifetime_giving_count__c
--  							, c4_current_calendar_year_giving__c=npsp_staging.stg_fact_giving_summary.c4_current_calendar_year_giving__c
--  							, c4_last_calendar_year_giving__c=npsp_staging.stg_fact_giving_summary.c4_last_calendar_year_giving__c
--  							, c4_second_calendar_year_giving__c=npsp_staging.stg_fact_giving_summary.c4_second_calendar_year_giving__c
--  							, c4_third_calendar_year_giving__c=npsp_staging.stg_fact_giving_summary.c4_third_calendar_year_giving__c
--  							, c4_fourth_calendar_year_giving__c=npsp_staging.stg_fact_giving_summary.c4_fourth_calendar_year_giving__c
--  							, c4_first_gift_amount__c=npsp_staging.stg_fact_giving_summary.c4_first_gift_amount__c
--  							, c4_first_gift_date__c=npsp_staging.stg_fact_giving_summary.c4_first_gift_date__c
--  							, c4_first_gift_id__c=npsp_staging.stg_fact_giving_summary.c4_first_gift_id__c
--  							, c4_first_gift_source__c=npsp_staging.stg_fact_giving_summary.c4_first_gift_source__c
--  							, c4_largest_gift_amount__c=npsp_staging.stg_fact_giving_summary.c4_largest_gift_amount__c
--  							, c4_largest_gift_date__c=npsp_staging.stg_fact_giving_summary.c4_largest_gift_date__c
--  							, c4_largest_gift_id__c=npsp_staging.stg_fact_giving_summary.c4_largest_gift_id__c
--  							, c4_largest_gift_source__c=npsp_staging.stg_fact_giving_summary.c4_largest_gift_source__c
--  							, c4_last_gift_amount__c=npsp_staging.stg_fact_giving_summary.c4_last_gift_amount__c
--  							, c4_last_gift_date__c=npsp_staging.stg_fact_giving_summary.c4_last_gift_date__c
--  							, c4_last_gift_id__c=npsp_staging.stg_fact_giving_summary.c4_last_gift_id__c
--  							, c4_last_gift_source__c=npsp_staging.stg_fact_giving_summary.c4_last_gift_source__c
--  							, c4_largest_recent_gift_amount__c=npsp_staging.stg_fact_giving_summary.c4_largest_recent_gift_amount__c
--  							, c4_largest_recent_gift_date__c=npsp_staging.stg_fact_giving_summary.c4_largest_recent_gift_date__c
--  							, c4_largest_recent_gift_id__c=npsp_staging.stg_fact_giving_summary.c4_largest_recent_gift_id__c
--  							, c4_largest_recent_gift_source__c=npsp_staging.stg_fact_giving_summary.c4_largest_recent_gift_source__c
--  							, c4_lifetime_giving_amount__c=npsp_staging.stg_fact_giving_summary.c4_lifetime_giving_amount__c
--  							, c4_lifetime_giving_count__c=npsp_staging.stg_fact_giving_summary.c4_lifetime_giving_count__c
--  							, current_calendar_year_giving_amount__c=npsp_staging.stg_fact_giving_summary.current_calendar_year_giving_amount__c
--  							, date_inserted__c=npsp_staging.stg_fact_giving_summary.date_inserted__c
--  							, first_gift_amount__c=npsp_staging.stg_fact_giving_summary.first_gift_amount__c
--  							, first_gift_date__c=npsp_staging.stg_fact_giving_summary.first_gift_date__c
--  							, first_gift_id__c=npsp_staging.stg_fact_giving_summary.first_gift_id__c
--  							, first_gift_source_code__c=npsp_staging.stg_fact_giving_summary.first_gift_source_code__c
--  							, largest_gift_amount__c=npsp_staging.stg_fact_giving_summary.largest_gift_amount__c
--  							, largest_gift_date__c=npsp_staging.stg_fact_giving_summary.largest_gift_date__c
--  							, largest_gift_id__c=npsp_staging.stg_fact_giving_summary.largest_gift_id__c
--  							, largest_gift_source_code__c=npsp_staging.stg_fact_giving_summary.largest_gift_source_code__c
--  							, last_calendar_year_giving_amount__c=npsp_staging.stg_fact_giving_summary.last_calendar_year_giving_amount__c
--  							, last_gift_amount__c=npsp_staging.stg_fact_giving_summary.last_gift_amount__c
--  							, last_gift_date__c=npsp_staging.stg_fact_giving_summary.last_gift_date__c
--  							, last_gift_id__c=npsp_staging.stg_fact_giving_summary.last_gift_id__c
--  							, last_gift_source_code__c=npsp_staging.stg_fact_giving_summary.last_gift_source_code__c
--  							, largest_recent_gift_amount__c=npsp_staging.stg_fact_giving_summary.largest_recent_gift_amount__c
--  							, largest_recent_gift_date__c=npsp_staging.stg_fact_giving_summary.largest_recent_gift_date__c
--  							, largest_recent_gift_id__c=npsp_staging.stg_fact_giving_summary.largest_recent_gift_id__c
--  							, largest_recent_gift_source__c=npsp_staging.stg_fact_giving_summary.largest_recent_gift_source__c
--  							, lifetime_giving_amount__c=npsp_staging.stg_fact_giving_summary.lifetime_giving_amount__c
--  							, lifetime_pac_giving_amount__c=npsp_staging.stg_fact_giving_summary.lifetime_pac_giving_amount__c
--  							, lifetime_pac_giving_count__c=npsp_staging.stg_fact_giving_summary.lifetime_pac_giving_count__c
--  							, pac_current_calendar_year_giving__c=npsp_staging.stg_fact_giving_summary.pac_current_calendar_year_giving__c
--  							, pac_last_calendar_year_giving__c=npsp_staging.stg_fact_giving_summary.pac_last_calendar_year_giving__c
--  							, pac_second_calendar_year_giving__c=npsp_staging.stg_fact_giving_summary.pac_second_calendar_year_giving__c
--  							, pac_third_calendar_year_giving__c=npsp_staging.stg_fact_giving_summary.pac_third_calendar_year_giving__c
--  							, pac_fourth_calendar_year_giving__c=npsp_staging.stg_fact_giving_summary.pac_fourth_calendar_year_giving__c
--  							, second_calendar_year_giving_amount__c=npsp_staging.stg_fact_giving_summary.second_calendar_year_giving_amount__c
--  							, third_calendar_year_giving_amount__c=npsp_staging.stg_fact_giving_summary.third_calendar_year_giving_amount__c
--  							, fourth_calendar_year_giving_amount__c=npsp_staging.stg_fact_giving_summary.fourth_calendar_year_giving_amount__c
--  							, last_modified_date=npsp_staging.stg_fact_giving_summary.last_modified_date
--  						WHEN NOT MATCHED
--  						THEN INSERT (giving_summary_id
--  								, giving_summary_external_id
--  								, giving_summary_type
--  								, accountid
--  								, c3_current_calendar_year_giving_amount__c
--  								, c3_last_calendar_year_giving__c
--  								, c3_second_calendar_year_giving__c
--  								, c3_third_calendar_year_giving__c
--  								, c3_fourth_calendar_year_giving__c
--  								, c3_first_gift_amount__c
--  								, c3_first_gift_date__c
--  								, c3_first_gift_id__c
--  								, c3_first_gift_source__c
--  								, c3_largest_gift_amount__c
--  								, c3_largest_gift_date__c
--  								, c3_largest_gift_id__c
--  								, c3_largest_gift_source__c
--  								, c3_last_gift_amount__c
--  								, c3_last_gift_date__c
--  								, c3_last_gift_id__c
--  								, c3_last_gift_source__c
--  								, c3_largest_recent_gift_amount__c
--  								, c3_largest_recent_gift_date__c
--  								, c3_largest_recent_gift_id__c
--  								, c3_largest_recent_gift_source__c
--  								, c3_lifetime_giving_amount__c
--  								, c3_lifetime_giving_count__c
--  								, c4_current_calendar_year_giving__c
--  								, c4_last_calendar_year_giving__c
--  								, c4_second_calendar_year_giving__c
--  								, c4_third_calendar_year_giving__c
--  								, c4_fourth_calendar_year_giving__c
--  								, c4_first_gift_amount__c
--  								, c4_first_gift_date__c
--  								, c4_first_gift_id__c
--  								, c4_first_gift_source__c
--  								, c4_largest_gift_amount__c
--  								, c4_largest_gift_date__c
--  								, c4_largest_gift_id__c
--  								, c4_largest_gift_source__c
--  								, c4_last_gift_amount__c
--  								, c4_last_gift_date__c
--  								, c4_last_gift_id__c
--  								, c4_last_gift_source__c
--  								, c4_largest_recent_gift_amount__c
--  								, c4_largest_recent_gift_date__c
--  								, c4_largest_recent_gift_id__c
--  								, c4_largest_recent_gift_source__c
--  								, c4_lifetime_giving_amount__c
--  								, c4_lifetime_giving_count__c
--  								, current_calendar_year_giving_amount__c
--  								, date_inserted__c
--  								, first_gift_amount__c
--  								, first_gift_date__c
--  								, first_gift_id__c
--  								, first_gift_source_code__c
--  								, largest_gift_amount__c
--  								, largest_gift_date__c
--  								, largest_gift_id__c
--  								, largest_gift_source_code__c
--  								, last_calendar_year_giving_amount__c
--  								, last_gift_amount__c
--  								, last_gift_date__c
--  								, last_gift_id__c
--  								, last_gift_source_code__c
--  								, largest_recent_gift_amount__c
--  								, largest_recent_gift_date__c
--  								, largest_recent_gift_id__c
--  								, largest_recent_gift_source__c
--  								, lifetime_giving_amount__c
--  								, lifetime_pac_giving_amount__c
--  								, lifetime_pac_giving_count__c
--  								, pac_current_calendar_year_giving__c
--  								, pac_last_calendar_year_giving__c
--  								, pac_second_calendar_year_giving__c
--  								, pac_third_calendar_year_giving__c
--  								, pac_fourth_calendar_year_giving__c
--  								, lifetime_giving_count__c
--  								, second_calendar_year_giving_amount__c
--  								, third_calendar_year_giving_amount__c
--  								, fourth_calendar_year_giving_amount__c
--  								, last_modified_date)
--  						VALUES (npsp_staging.stg_fact_giving_summary.giving_summary_id
--  							, npsp_staging.stg_fact_giving_summary.giving_summary_external_id__c
--  							, npsp_staging.stg_fact_giving_summary.type__c
--  							, npsp_staging.stg_fact_giving_summary.accountid
--  							, npsp_staging.stg_fact_giving_summary.c3_current_calendar_year_giving_amount__c
--  							, npsp_staging.stg_fact_giving_summary.c3_last_calendar_year_giving__c
--  							, npsp_staging.stg_fact_giving_summary.c3_second_calendar_year_giving__c
--  							, npsp_staging.stg_fact_giving_summary.c3_third_calendar_year_giving__c
--  							, npsp_staging.stg_fact_giving_summary.c3_fourth_calendar_year_giving__c
--  							, npsp_staging.stg_fact_giving_summary.c3_first_gift_amount__c
--  							, npsp_staging.stg_fact_giving_summary.c3_first_gift_date__c
--  							, npsp_staging.stg_fact_giving_summary.c3_first_gift_id__c
--  							, npsp_staging.stg_fact_giving_summary.c3_first_gift_source__c
--  							, npsp_staging.stg_fact_giving_summary.c3_largest_gift_amount__c
--  							, npsp_staging.stg_fact_giving_summary.c3_largest_gift_date__c
--  							, npsp_staging.stg_fact_giving_summary.c3_largest_gift_id__c
--  							, npsp_staging.stg_fact_giving_summary.c3_largest_gift_source__c
--  							, npsp_staging.stg_fact_giving_summary.c3_last_gift_amount__c
--  							, npsp_staging.stg_fact_giving_summary.c3_last_gift_date__c
--  							, npsp_staging.stg_fact_giving_summary.c3_last_gift_id__c
--  							, npsp_staging.stg_fact_giving_summary.c3_last_gift_source__c
--  							, npsp_staging.stg_fact_giving_summary.c3_largest_recent_gift_amount__c
--  							, npsp_staging.stg_fact_giving_summary.c3_largest_recent_gift_date__c
--  							, npsp_staging.stg_fact_giving_summary.c3_largest_recent_gift_id__c
--  							, npsp_staging.stg_fact_giving_summary.c3_largest_recent_gift_source__c
--  							, npsp_staging.stg_fact_giving_summary.c3_lifetime_giving_amount__c
--  							, npsp_staging.stg_fact_giving_summary.c3_lifetime_giving_count__c
--  							, npsp_staging.stg_fact_giving_summary.c4_current_calendar_year_giving__c
--  							, npsp_staging.stg_fact_giving_summary.c4_last_calendar_year_giving__c
--  							, npsp_staging.stg_fact_giving_summary.c4_second_calendar_year_giving__c
--  							, npsp_staging.stg_fact_giving_summary.c4_third_calendar_year_giving__c
--  							, npsp_staging.stg_fact_giving_summary.c4_fourth_calendar_year_giving__c
--  							, npsp_staging.stg_fact_giving_summary.c4_first_gift_amount__c
--  							, npsp_staging.stg_fact_giving_summary.c4_first_gift_date__c
--  							, npsp_staging.stg_fact_giving_summary.c4_first_gift_id__c
--  							, npsp_staging.stg_fact_giving_summary.c4_first_gift_source__c
--  							, npsp_staging.stg_fact_giving_summary.c4_largest_gift_amount__c
--  							, npsp_staging.stg_fact_giving_summary.c4_largest_gift_date__c
--  							, npsp_staging.stg_fact_giving_summary.c4_largest_gift_id__c
--  							, npsp_staging.stg_fact_giving_summary.c4_largest_gift_source__c
--  							, npsp_staging.stg_fact_giving_summary.c4_last_gift_amount__c
--  							, npsp_staging.stg_fact_giving_summary.c4_last_gift_date__c
--  							, npsp_staging.stg_fact_giving_summary.c4_last_gift_id__c
--  							, npsp_staging.stg_fact_giving_summary.c4_last_gift_source__c
--  							, npsp_staging.stg_fact_giving_summary.c4_largest_recent_gift_amount__c
--  							, npsp_staging.stg_fact_giving_summary.c4_largest_recent_gift_date__c
--  							, npsp_staging.stg_fact_giving_summary.c4_largest_recent_gift_id__c
--  							, npsp_staging.stg_fact_giving_summary.c4_largest_recent_gift_source__c
--  							, npsp_staging.stg_fact_giving_summary.c4_lifetime_giving_amount__c
--  							, npsp_staging.stg_fact_giving_summary.c4_lifetime_giving_count__c
--  							, npsp_staging.stg_fact_giving_summary.current_calendar_year_giving_amount__c
--  							, npsp_staging.stg_fact_giving_summary.date_inserted__c
--  							, npsp_staging.stg_fact_giving_summary.first_gift_amount__c
--  							, npsp_staging.stg_fact_giving_summary.first_gift_date__c
--  							, npsp_staging.stg_fact_giving_summary.first_gift_id__c
--  							, npsp_staging.stg_fact_giving_summary.first_gift_source_code__c
--  							, npsp_staging.stg_fact_giving_summary.largest_gift_amount__c
--  							, npsp_staging.stg_fact_giving_summary.largest_gift_date__c
--  							, npsp_staging.stg_fact_giving_summary.largest_gift_id__c
--  							, npsp_staging.stg_fact_giving_summary.largest_gift_source_code__c
--  							, npsp_staging.stg_fact_giving_summary.last_calendar_year_giving_amount__c
--  							, npsp_staging.stg_fact_giving_summary.last_gift_amount__c
--  							, npsp_staging.stg_fact_giving_summary.last_gift_date__c
--  							, npsp_staging.stg_fact_giving_summary.last_gift_id__c
--  							, npsp_staging.stg_fact_giving_summary.last_gift_source_code__c
--  							, npsp_staging.stg_fact_giving_summary.largest_recent_gift_amount__c
--  							, npsp_staging.stg_fact_giving_summary.largest_recent_gift_date__c
--  							, npsp_staging.stg_fact_giving_summary.largest_recent_gift_id__c
--  							, npsp_staging.stg_fact_giving_summary.largest_recent_gift_source__c
--  							, npsp_staging.stg_fact_giving_summary.lifetime_giving_amount__c
--  							, npsp_staging.stg_fact_giving_summary.lifetime_pac_giving_amount__c
--  							, npsp_staging.stg_fact_giving_summary.lifetime_pac_giving_count__c
--  							, npsp_staging.stg_fact_giving_summary.pac_current_calendar_year_giving__c
--  							, npsp_staging.stg_fact_giving_summary.pac_last_calendar_year_giving__c
--  							, npsp_staging.stg_fact_giving_summary.pac_second_calendar_year_giving__c
--  							, npsp_staging.stg_fact_giving_summary.pac_third_calendar_year_giving__c
--  							, npsp_staging.stg_fact_giving_summary.pac_fourth_calendar_year_giving__c
--  							, npsp_staging.stg_fact_giving_summary.lifetime_giving_count__c
--  							, npsp_staging.stg_fact_giving_summary.second_calendar_year_giving_amount__c
--  							, npsp_staging.stg_fact_giving_summary.third_calendar_year_giving_amount__c
--  							, npsp_staging.stg_fact_giving_summary.fourth_calendar_year_giving_amount__c
--  							, npsp_staging.stg_fact_giving_summary.last_modified_date)';
						
						
--  		EXECUTE mergeSQL;
			
			
--  		EXECUTE 'ANALYZE npsp_reporting.fact_giving_summary';
		
--  		OPEN drop_cur FOR SELECT giving_summary_type FROM npsp_reporting.dim_giving_summary_type;
		
--  	  	    -- Loops through a list of giving summary type names in the cursor to drop the materialized views
-- 	 	  	  LOOP
			        
-- 	 	  	      FETCH drop_cur INTO currentCategoryType;
			        
-- 	 	  	      EXIT WHEN NOT FOUND;
			        
-- 	 	  		 --Construct the final SQL statement to insert into the aggregated table
-- 	 	  		dropSQL := 'DROP TABLE IF EXISTS npsp_staging.stg_'||currentCategoryType;
					
-- 	 	  	         --Execute the constructed SQL
-- 	 	  	   		EXECUTE dropSQL;
-- 	 	  	END LOOP;
		    
--  	  CLOSE drop_cur;
	
--  END;
--  $$;