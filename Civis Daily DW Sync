version: '2.0'
workflow:
  credential_id: 29547
  remote_host_id: 174
  default_sql:
    remote_host_id: 174
    credential_id: 29547
  tasks:
    generate_timestamp:
      action: civis.scripts.sql
      input:
        remote_host_id: 174
        credential_id: 29547
        sql: |
          DROP TABLE IF EXISTS npsp_staging.stg_insert_timestamp;
          CREATE TABLE npsp_staging.stg_insert_timestamp
          AS SELECT CURRENT_TIMESTAMP::timestamp as v_insert_timestamp;
      on-success:
        - insert_into_job_history
    insert_into_job_history:
      action: civis.scripts.sql
      input:
        remote_host_id: 174
        credential_id: 29547
        sql: |
          INSERT INTO npsp_integration.job_history (jobid, lastrun,
          runstatus, notes)

          VALUES (13::INTEGER,(SELECT v_insert_timestamp FROM
          npsp_staging.stg_insert_timestamp),'started','Civis Aggregation
          Workflow has started');
      on-success:
        - get_last_modified_date
    get_last_modified_date:
      action: civis.scripts.sql
      input:
        remote_host_id: 174
        credential_id: 29547
        sql: |
          DROP TABLE IF EXISTS npsp_staging.stg_max_lastrun; 
          create table npsp_staging.stg_max_lastrun
          as
          select max(lastrun) max_date
          from npsp_integration.job_history
          where jobid = 10 and runstatus = 'complete'
      on-success:
        - run_golden_opps
      on-error:
        - handle_errors
    
    run_golden_opps:
      action: civis.run_job
      input:
        job_id: 219977409
      on-success:
        - run_giving_summary
      on-error:
        - handle_errors
    
    
    run_giving_summary:
      action: civis.run_job
      input:
        job_id: 237083252
      on-success:
        - run_account
        - run_contact
        - run_campaign
        - run_recurring_donations
        - run_attributes
        - populate_subledger
      on-error:
        - handle_errors
    
    
    
    run_account:
      action: civis.run_job
      input:
        job_id: 237093189
      on-success:
        - update_job_history
      on-error:
        - handle_errors
    
    
    run_contact:
      action: civis.run_job
      input:
        job_id: 237082876
      on-success:
        - update_job_history
      on-error:
        - handle_errors
    
    
    run_campaign:
      action: civis.run_job
      input:
        job_id: 237061374
      on-success:
        - update_job_history
      on-error:
        - handle_errors
    
    
    run_recurring_donations:
      action: civis.run_job
      input:
        job_id: 237056580
      on-success:
        - update_job_history
      on-error:
        - handle_errors
    
    
    run_attributes:
      action: civis.run_job
      input:
        job_id: 237277355
      on-success:
        - update_job_history
      on-error:
        - handle_errors
    
    populate_subledger:
      action: civis.run_job
      input:
        job_id: 237486402
      on-success:
        - nightly_subledger
      on-error:
        - handle_errors
    
    
    nightly_subledger:
      action: civis.run_job
      input:
        job_id: 237486273
      on-success:
        - update_job_history
        - sanity_check
      on-error:
        - handle_errors

    sanity_check:
      action: civis.run_job
      input:
        jobid: 241530877
    


    update_job_history:
      action: civis.scripts.sql
      input:
        remote_host_id: 174
        credential_id: 29547
        sql: >
          update npsp_integration.job_history

          set runstatus = 'complete', lastrun = current_timestamp, notes =
          'Civis Aggregation Workflow has completed successfully'

          where jobid = 13 and runstatus = 'started' and lastrun = (SELECT
          v_insert_timestamp FROM npsp_staging.stg_insert_timestamp);
      join: all
      on-success:
        - Data_Mart_RowCount
    
    handle_errors:
      action: civis.scripts.sql
      input:
        remote_host_id: 174
        credential_id: 29547
        sql: >
          update npsp_integration.job_history

          set runstatus = 'failed', lastrun = current_timestamp, notes = 'Civis
          Aggregation Workflow has failed'

          where jobid = 13 and runstatus = 'started' and lastrun = (SELECT
          v_insert_timestamp FROM npsp_staging.stg_insert_timestamp);
      on-success:
        - fail_workflow
    
    
    Data_Mart_RowCount:
      action: civis.run_job
      join: all
      input:
        job_id: 239083880



    fail_workflow:
        action: std.fail
        input:
            message: "The main task failed. Check the job step history for more details."

