DROP TABLE IF EXISTS rounddata.supreme_reporting_table;
CREATE TABLE rounddata.supreme_reporting_table (
 closedate               DATETIME      DEFAULT NULL
,deposit_date            DATETIME      DEFAULT NULL
,datepulled              DATETIME
,amount                  DECIMAL(38,2) DEFAULT NULL
,data_source             VARCHAR(15)   NOT NULL
,etl_id                  INT       NOT NULL
,delete_flag             VARCHAR(24)    NOT NULL
,affiliate_number        VARCHAR(100)  DEFAULT NULL
,channel                 VARCHAR(30)   DEFAULT NULL
,payment_subtype         varchar(30)
,is_sustainer            VARCHAR(7)    DEFAULT NULL
,ngoc_accountid          VARCHAR(18)   DEFAULT NULL
,parent_transaction_id   VARCHAR(18)   DEFAULT NULL
,transaction_id          VARCHAR(18)   DEFAULT NULL
,createdbyid             VARCHAR(18)   DEFAULT NULL
,lastmodifiedbyid        VARCHAR(18)   DEFAULT NULL
,source_code             VARCHAR(150)  DEFAULT NULL
,original_source_code    VARCHAR(25)   DEFAULT NULL
,pledge_number           VARCHAR(150)  DEFAULT NULL
,stagename               VARCHAR(150)  DEFAULT NULL
,rc_giving__archive_flag VARCHAR(5)    DEFAULT NULL
,bookable                VARCHAR(6)    DEFAULT NULL
,payment_method          VARCHAR(150)  DEFAULT NULL
,gau_credit_code         VARCHAR(30)   DEFAULT NULL
,gau_debit_code          VARCHAR(30)   DEFAULT NULL
,recordtype              VARCHAR(80)   DEFAULT NULL
,is_pass_through         INT      DEFAULT NULL
,cfp_shareable           VARCHAR(7)    DEFAULT NULL
,is_local                VARCHAR(8)    DEFAULT NULL
,entity                  VARCHAR(3)    DEFAULT NULL
,office                  VARCHAR(41)    DEFAULT NULL
,business_unit           VARCHAR(19)    DEFAULT NULL
,group_code              VARCHAR(21)    DEFAULT NULL
,campaign_code           VARCHAR(25)    DEFAULT NULL
,fiscal_month            VARCHAR(2)    DEFAULT NULL
,fiscal_year             VARCHAR(42)    DEFAULT NULL
,First_Gift_Natl_c3      VARCHAR(12)    DEFAULT 'N'
,First_Gift_Natl_c4      VARCHAR(13)    DEFAULT 'N'
,Donor_c3_affil_number   VARCHAR(22)   DEFAULT NULL
,Donor_C4_affil_number   VARCHAR(23)   DEFAULT NULL
,Adjusted                VARCHAR(14)    DEFAULT NULL
,IsGivingVehicle         VARCHAR(15)
,Credit_Type             VARCHAR(43)
,Giving_level_pre_gift   VARCHAR(16)    DEFAULT NULL
,Giving_Number           VARCHAR(500)
,reportable_revenue      varchar(26)
,has_soft_credit         varchar(27));

---Table for has_soft_credit field
DROP TABLE IF EXISTS akaplan.mv_soft_credit_opportunities ;
  CREATE TABLE akaplan.mv_soft_credit_opportunities (rC_Giving__Opportunity VARCHAR(18), PRIMARY KEY (rC_Giving__Opportunity) ) ;
  INSERT INTO mv_soft_credit_opportunities
  SELECT DISTINCT rC_Giving__Opportunity AS rc_giving__opportunity
  FROM rounddata.rc_giving__opportunity_credit
  WHERE delete_flag<>'Y' OR rc_giving__archive_flag ilike 'true'  ;
 
-- Giving Vehicle Preferences
drop table if exists akaplan.rc_bios__preference_vehicle;
create table akaplan.rc_bios__preference_vehicle as 
( select rc_bios__account from rounddata.rc_bios__preference where delete_flag <> 'Y' and rc_bios__active ilike 'true' and rc_bios__subcategory = 'Giving Vehicle' );
  
    
    
INSERT INTO rounddata.supreme_reporting_table (  
  --------------------------
  --TRANSACTIONS
  --------------------------
    SELECT opportunity.closedate                                                                              closedate
         ,CASE WHEN opportunity.deposit_date IS NOT NULL THEN opportunity.deposit_date
               ELSE opportunity.adjusted_deposit_date
          END                                                                                                 deposit_date
         ,SYSDATE                                                                                             datepulled
         ,coalesce(opportunity.final_amount, opportunity.amount)                                             amount
         ,recordtype.namex                                                                                    data_source
         ,opportunity.etl_id                                                                                  etl_id
         ,opportunity.delete_flag                                                                             delete_flag
         ,opportunity.affiliate_number                                                                        affiliate_number
         ,campaign.rc_giving__channel                                                                         channel
         ,rc_giving__payment_method.payment_subtype                                                           payment_subtype
         ,CASE WHEN parent_opportunity.rc_giving__is_sustainer ilike 'true'
               THEN 'offline'
               WHEN campaign.SourceCode_Campaign_Code = 'W'
               THEN 'online'
               ELSE NULL
          END                                                                                                 is_sustainer
         ,opportunity.accountid                                                                               ngoc_accountid
         ,opportunity.rc_giving__parent                                                                       parent_transaction_id
         ,opportunity.id                                                                                      transaction_id
         ,opportunity.createdbyid                                                                             createdbyid
         ,opportunity.lastmodifiedbyid                                                                        lastmodifiedbyid
         ,opportunity.rc_giving__source_code                                                                  source_code
         ,opportunity.original_source_code                                                                    original_source_code
         ,CASE WHEN recordtype.namex = 'Pledge Payment'
               THEN opportunity.pledge_number
          END                                                                                                 pledge_number
         ,opportunity.stagename                                                                               stagename
         ,opportunity.rc_giving__archive_flag                                                                 rc_giving__archive_flag
         ,parent_opportunity.rc_giving__is_bookable                                                           bookable
         ,opportunity.rc_giving__payment_method                                                               payment_method
         ,opportunity.gau_credit_code                                                                         gau_credit_code
         ,opportunity.gau_debit_code                                                                          gau_debit_code
         ,recordtype.namex                                                                                    recordtype
         ,CASE WHEN opportunity.gau_credit_code IN
               ('C325005','C325015','11000000000002340','11000000000002356','C340100TR422ONL') -- added C340100TR422ONL per case 52904
               THEN 1
               ELSE 0
          END   is_pass_through
        ,CASE WHEN opportunity.closedate >= '2011-07-01'
              AND (
                    (
                       campaign.sourcecode_office_code = 'N'
                       AND 
                       (
                        opportunity.affiliate_number in ('090030','090330','090430','091460')
                       AND substring(opportunity.gau_credit_code,1,3) = 'C34'
                       AND substring(opportunity.gau_credit_code,8,2) = 'UR'
                       AND substring(opportunity.gau_credit_code,13,3) in ('AQT','RSO','MLS','ONL','PMG')
                       AND opportunity.nps_exclude not ilike 'True' 
                       ) 
                       OR
                       ( 
                         opportunity.gau_credit_code like 'C340210%' 
                       )
                    )
              OR ( campaign.sourcecode_office_code = 'C'      --Added this OR per case 52909 (Legacy Web sustainers with C Source)
                  AND 
                       (
                        opportunity.affiliate_number in ('090030','090330','090430','091460')
                       AND substring(opportunity.gau_credit_code,1,3) = 'C34'
                       AND substring(opportunity.gau_credit_code,8,2) = 'UR'
                       AND substring(opportunity.gau_credit_code,13,3) in ('AQT','RSO','MLS','ONL','PMG')
                       AND opportunity.nps_exclude not ilike 'True' 
                       ) 
                 ) 
              OR ( campaign.sourcecode_office_code in ('L','P','E','A','W')
                   AND
                   opportunity.gau_credit_code like '%CFP'
                 )
              OR ( campaign.sourcecode_office_code in ('N','C')
                   AND ( opportunity.gau_credit_code like '_9001%'
                         OR opportunity.gau_credit_code like '_9002%'
                         OR opportunity.gau_credit_code like '_9003%'
                         OR opportunity.gau_credit_code like '_9004%'
                         OR opportunity.gau_credit_code like '_9005%')
                        )
                  OR (campaign.sourcecode_office_code in ('N','C')
                      and substring(opportunity.gau_credit_code,1,3) = 'C34'
                      and substring(opportunity.gau_credit_code,8,2) = 'UR'
                      and substring(opportunity.gau_credit_code,16,4) in ('A152','A113','A118','A126','A155')
                     )
                 )
              THEN 'Y'
              -- PP Keystone added 2019-07-23 cdelja per ariel
              WHEN opportunity.closedate >= '2019-07-01'
              AND (
                     (     campaign.sourcecode_office_code = 'N'
                       AND opportunity.affiliate_number = '091410'
                       AND substring(opportunity.gau_credit_code,1,3) = 'C34'
                       AND substring(opportunity.gau_credit_code,8,2) = 'UR'
                       AND substring(opportunity.gau_credit_code,13,3) in ('AQT','RSO','MLS','ONL','PMG')
                       AND opportunity.nps_exclude not ilike 'True' -- added NOT per case 52909
                      )
                   OR (     campaign.sourcecode_office_code = 'K'
                        AND opportunity.gau_credit_code like '%CFP'
                      )
                  )
              THEN 'Y'
              WHEN (substring(opportunity.gau_credit_code,1,9) = 'C340600UR'
                    and
                    opportunity.affiliate_number in ('090030','090330','090430','091460','091410')
                   )
              OR (campaign.SourceCode_Activity_Type_Code = '3NP'
                  and
                  substring(campaign.SourceCode_Segment_Code,1,1) = 'C'
                 )
              THEN 'Y'
              /* SENFL Case 56005 */
              WHEN opportunity.closedate >= '2020-07-01'
              AND (
                     (     campaign.sourcecode_office_code = 'N'
                       AND opportunity.affiliate_number = '090320'
                       AND substring(opportunity.gau_credit_code,1,3) = 'C34'
                       AND substring(opportunity.gau_credit_code,8,2) = 'UR'
                       AND substring(opportunity.gau_credit_code,13,3) in ('AQT','RSO','MLS','ONL','PMG')
                       AND opportunity.nps_exclude not ilike 'True' -- added NOT per case 52909
                      )
                   OR (     campaign.sourcecode_office_code = 'F'
                        AND opportunity.gau_credit_code like '%CFP'
                      )
                   OR (
                            substring(opportunity.gau_credit_code,1,9) = 'C340600UR'
                        and opportunity.affiliate_number = '090320'
                      )
                   OR (
                            campaign.SourceCode_Activity_Type_Code = '3NP'
                        and substring(Campaign.SourceCode_Segment_Code,1,1) = 'C'
                        and opportunity.affiliate_number = '090320')
                  )
              THEN 'Y'
              ELSE 'N'
          END  AS cfp_shareable
         ,CASE 
               -- WHEN SUBSTR(opportunity.rc_giving__source_code, 2,1) IN ('L','P','E','A','W')
               WHEN campaign.SourceCode_Office_Description IN ('Arizona','Illinois','Southeastern Pennsylvania','Southeast','Keystone','South East North Florida')
                    AND  opportunity.gau_credit_code NOT LIKE '%CFP'
               THEN 'Y'
               ELSE 'N'
          END   AS is_local
         -- CASE WHEN SUBSTR(opportunity.rc_giving__source_code,1,1) = '3'
         --      THEN 'C3'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,1,1) = '4'
         --      THEN 'C4'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,1,1) = '5'
         --      THEN 'PAC'
         -- END AS entity
         ,campaign.SourceCode_Tax_Status_Description AS entity
         -- CASE WHEN SUBSTR(opportunity.rc_giving__source_code,2,1) = 'N'
         --      THEN 'PPFA'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,2,1) = 'L'
         --      THEN 'PPIL'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,2,1) = 'P'
         --      THEN 'PPSP'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,2,1) = 'A'
         --      THEN 'PPAZ'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,2,1) = 'E'
         --      THEN 'PPSE'
         -- END AS office
         ,campaign.sourceCode_Office_description AS office
         -- SUBSTR(opportunity.rc_giving__source_code,3,1) AS business_unit
         ,campaign.sourceCode_Business_Unit_Description    AS business_unit
         -- CASE WHEN SUBSTR(opportunity.rc_giving__source_code,4,1) = 'L'
         --      THEN 'Low'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,4,1) = 'D'
         --      THEN 'Mid'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,4,1) = 'M'
         --      THEN 'Major'
         -- END AS group_code
         ,campaign.sourceCode_Activity_Group_Description AS group_code
         -- SUBSTR(opportunity.rc_giving__source_code,5,1) AS campaign_code
         ,campaign.sourceCode_Campaign_Description       AS campaign_code
         ,CASE WHEN opportunity.ppfa_fiscal_month IS NOT NULL THEN opportunity.ppfa_fiscal_month
               WHEN opportunity.deposit_date IS NOT NULL THEN akaplan.ppfa_fiscal_month(opportunity.deposit_date):: char
               ELSE akaplan.ppfa_fiscal_month(opportunity.adjusted_deposit_date):: char
          END
         ,CASE WHEN opportunity.ppfa_fiscal_year IS NOT NULL THEN opportunity.ppfa_fiscal_year
               WHEN opportunity.deposit_date IS NOT NULL THEN akaplan.ppfa_fiscal_year(opportunity.deposit_date)
               ELSE akaplan.ppfa_fiscal_year(opportunity.adjusted_deposit_date)
          END
         ,CASE WHEN opportunity.id = (SELECT c3_first_gift_id
                                  FROM rounddata.giving_summary x
                                  WHERE x.accountid = opportunity.accountid
                                 )
               THEN 'Y'
               ELSE 'N'
          END                                              AS First_Gift_Natl_c3
         ,CASE WHEN opportunity.id = (SELECT c4_first_gift_id
                                  FROM rounddata.giving_summary x
                                  WHERE x.accountid = opportunity.accountid
                                     )
               THEN 'Y'
               ELSE 'N'
          END                                            AS First_Gift_Natl_c4
         ,a.c3_affiliate_number                          AS Donor_c3_affil_number
         ,a.c4_affiliate_number                          AS Donor_C4_affil_number
         ,CASE WHEN opportunity.adjusted ilike 'TRUE'
               THEN 'Y'
               ELSE 'N'
          END                                            AS Adjusted
         ,CASE WHEN vehicle.rc_bios__account IS NOT NULL
               THEN 'Y'
               ELSE 'N'
           END                                           AS IsGivingVehicle
         ,'HARD'                                         AS Credit_Type
         ,NULL                                           AS Giving_level_pre_gift
         ,opportunity.rC_Giving__Giving_Number           AS Giving_Number
         ,CASE WHEN recordtype.namex = 'Transaction'
               AND opportunity.stagename = 'Completed'
               THEN 1
               WHEN recordtype.namex ilike 'Pledge Payment'
               AND  opportunity.stagename  ilike 'Completed'
               AND  parent_opportunity.rc_giving__is_bookable ilike 'FALSE'
               THEN 1
               WHEN recordtype.namex = 'Pledge'
               AND opportunity.stagename IN ( 'Completed','Partially Collected','Partially Complete')
               THEN 1
               ELSE 0
          END             AS reportable_revenue
         ,CASE WHEN soft_credit.rc_giving__opportunity IS NOT NULL THEN 'TRUE'
               ELSE NULL
          END       as has_soft_credit
FROM rounddata.opportunity opportunity
--JOIN supremeReporting_ID_tracker tracker                         ON opportunity.etl_id = tracker.etl_id
--    AND tracker.seq >= i
--    AND tracker.seq <= i + i_batch_size
JOIN rounddata.v_campaign campaign  ON opportunity.rc_giving__source_code = campaign.unique_source_code
JOIN rounddata.recordtype recordtype  ON opportunity.recordtypeid = recordtype.id
JOIN rounddata.accountx a   ON a.id = opportunity.accountid
JOIN rounddata.opportunity parent_opportunity ON opportunity.rc_giving__parent = parent_opportunity.id
LEFT JOIN rounddata.rc_giving__payment_method rc_giving__payment_method  ON opportunity.rc_giving__payment_method_sele = rc_giving__payment_method.id
LEFT JOIN akaplan.rc_bios__preference_vehicle vehicle ON opportunity.accountid = vehicle.rc_bios__account
-- 
LEFT JOIN akaplan.mv_soft_credit_opportunities   soft_credit  ON soft_credit.rc_giving__opportunity = opportunity.rc_giving__parent
-- 
WHERE recordtype.namex in ('Transaction','Pledge Payment')
AND opportunity.stagename = 'Completed'
AND parent_opportunity.rc_giving__is_bookable ilike 'false'
AND ( opportunity.delete_flag <>'Y' OR opportunity.rc_giving__archive_flag ilike 'TRUE')
AND opportunity.amount>0   -- added 20190520 by cdelja to remove adjustments
UNION ALL
    -- --------------------------------------------
    --
    -- Pledges
    --
    -- --------------------------------------------
SELECT opportunity.closedate                                                                              closedate
         ,CASE WHEN opportunity.deposit_date IS NOT NULL THEN opportunity.deposit_date
               ELSE opportunity.adjusted_deposit_date
          END                                                                                                 deposit_date
         ,SYSDATE                                                                                           datepulled
         -- ,opportunity.RC_GIVING__EXPECTED_GIVING_AMO                                     amount changed to rc_giving__current_giving_amou by cdelja 20190520
         ,opportunity.rc_giving__current_giving_amou                                                           amount
         ,'PLEDGE'                                                                                            data_source
         ,opportunity.etl_id                                                                                  etl_id
         ,opportunity.delete_flag                                                                             delete_flag
         ,opportunity.affiliate_number                                                                        affiliate_number
         ,campaign.rc_giving__channel                                                                         channel
         ,rc_giving__payment_method.payment_subtype                                                           payment_subtype
         ,NULL                                                                                                is_sustainer
         ,opportunity.accountid                                                                               ngoc_accountid
         ,opportunity.rc_giving__parent                                                                       parent_transaction_id
         ,opportunity.id                                                                                      transaction_id
         ,opportunity.createdbyid                                                                             createdbyid
         ,opportunity.lastmodifiedbyid                                                                        lastmodifiedbyid
         ,opportunity.rc_giving__source_code                                                                  source_code
         ,opportunity.original_source_code                                                                    original_source_code
         ,opportunity.opp_giving_number                                                                                                 pledge_number
         ,opportunity.stagename                                                                               stagename
         ,opportunity.rc_giving__archive_flag                                                                 rc_giving__archive_flag
         ,opportunity.rc_giving__is_bookable                                                                  bookable
         ,opportunity.rc_giving__payment_method                                                               payment_method
         ,opportunity.gau_credit_code                                                                         gau_credit_code
         ,opportunity.gau_debit_code                                                                          gau_debit_code
         ,recordtype.namex                                                                                    recordtype
         ,CASE WHEN opportunity.gau_credit_code IN
                ('C325005','C325015','11000000000002340','11000000000002356','C340100TR422ONL') -- added C340100TR422ONL per case 52904
               THEN 1
               ELSE 0
          END   is_pass_through
         ,CASE WHEN opportunity.closedate >= '2011-07-01'
              AND (
                    (
                       campaign.sourcecode_office_code = 'N'
                       AND 
                       (
                           opportunity.affiliate_number in ('090030','090330','090430','091460')
                       AND substring(opportunity.gau_credit_code,1,3) = 'C34'
                       AND substring(opportunity.gau_credit_code,8,2) = 'UR'
                       AND substring(opportunity.gau_credit_code,13,3) in ('AQT','RSO','MLS','ONL','PMG')
                       AND opportunity.nps_exclude not ilike 'True' 
                       ) 
                       OR
                       ( 
                         opportunity.gau_credit_code like 'C340210%' 
                       )
                    )
              OR ( campaign.sourcecode_office_code in ('L','P','E','A','W')
                   AND
                   opportunity.gau_credit_code like '%CFP'
                 )
              OR ( campaign.sourcecode_office_code in ('N','C')
                   AND ( opportunity.gau_credit_code like '_9001%'
                         OR opportunity.gau_credit_code like '_9002%'
                         OR opportunity.gau_credit_code like '_9003%'
                         OR opportunity.gau_credit_code like '_9004%'
                         OR opportunity.gau_credit_code like '_9005%')
                        )
                  OR (campaign.sourcecode_office_code in ('N','C')
                      and substring(opportunity.gau_credit_code,1,3) = 'C34'
                      and substring(opportunity.gau_credit_code,8,2) = 'UR'
                      and substring(opportunity.gau_credit_code,16,4) in ('A152','A113','A118','A126','A155')
                     )
                 )
              THEN 'Y'
              -- PP Keystone added 2019-07-23 cdelja per ariel
              WHEN opportunity.closedate >= '2019-07-01'
              AND (
                     (     campaign.sourcecode_office_code = 'N'
                       AND opportunity.affiliate_number = '091410'
                       AND substring(opportunity.gau_credit_code,1,3) = 'C34'
                       AND substring(opportunity.gau_credit_code,8,2) = 'UR'
                       AND substring(opportunity.gau_credit_code,13,3) in ('AQT','RSO','MLS','ONL','PMG')
                      )
                   OR (     campaign.sourcecode_office_code = 'K'
                        AND opportunity.gau_credit_code like '%CFP'
                      )
                  )
              THEN 'Y'
     WHEN (substring(opportunity.gau_credit_code,1,9) = 'C340600UR'
           and
           opportunity.affiliate_number in ('090030','090330','090430','091460','091410')
          )
     OR (campaign.SourceCode_Activity_Type_Code = '3NP'
         and
         substring(campaign.SourceCode_Segment_Code,1,1) = 'C'
        )
              THEN 'Y'
           /* SENFL Case 56005               */
              WHEN opportunity.closedate >= '2020-07-01'
              AND (
                     (     campaign.sourcecode_office_code = 'N'
                       AND opportunity.affiliate_number = '090320'
                       AND substring(opportunity.gau_credit_code,1,3) = 'C34'
                       AND substring(opportunity.gau_credit_code,8,2) = 'UR'
                       AND substring(opportunity.gau_credit_code,13,3) in ('AQT','RSO','MLS','ONL','PMG')
                       AND opportunity.nps_exclude not ilike 'True' -- added NOT per case 52909
                      )
                   OR (     campaign.sourcecode_office_code = 'F'
                        AND opportunity.gau_credit_code like '%CFP'
                      )
                   OR (
                            substring(opportunity.gau_credit_code,1,9) = 'C340600UR'
                        and opportunity.affiliate_number = '090320'
                      )
                   OR (
                            campaign.SourceCode_Activity_Type_Code = '3NP'
                        and substring(Campaign.SourceCode_Segment_Code,1,1) = 'C'
                        and opportunity.affiliate_number = '090320')
                  )
              THEN 'Y'
              ELSE 'N'
          END  AS cfp_shareable
         ,CASE -- WHEN SUBSTR(opportunity.rc_giving__source_code, 2,1) IN ('L','P','E','A','W')
               WHEN campaign.SourceCode_Office_Description IN ('Arizona','Illinois','Southeastern Pennsylvania','Southeast','Keystone','South East North Florida')
                    AND  opportunity.gau_credit_code NOT LIKE '%CFP'
               THEN 'Y'
               ELSE 'N'
          END   AS is_local
         -- CASE WHEN SUBSTR(opportunity.rc_giving__source_code,1,1) = '3'
         --      THEN 'C3'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,1,1) = '4'
         --      THEN 'C4'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,1,1) = '5'
         --      THEN 'PAC'
         -- END AS entity
         ,campaign.SourceCode_Tax_Status_Description AS entity
         -- CASE WHEN SUBSTR(opportunity.rc_giving__source_code,2,1) = 'N'
         --      THEN 'PPFA'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,2,1) = 'L'
         --      THEN 'PPIL'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,2,1) = 'P'
         --      THEN 'PPSP'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,2,1) = 'A'
         --      THEN 'PPAZ'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,2,1) = 'E'
         --      THEN 'PPSE'
         -- END AS office
         ,campaign.sourceCode_Office_description AS office
         -- SUBSTR(opportunity.rc_giving__source_code,3,1) AS business_unit
         ,campaign.sourceCode_Business_Unit_Description    AS business_unit
         -- CASE WHEN SUBSTR(opportunity.rc_giving__source_code,4,1) = 'L'
         --      THEN 'Low'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,4,1) = 'D'
         --      THEN 'Mid'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,4,1) = 'M'
         --      THEN 'Major'
         -- END AS group_code
         ,campaign.sourceCode_Activity_Group_Description AS group_code
         -- SUBSTR(opportunity.rc_giving__source_code,5,1) AS campaign_code
         ,campaign.sourceCode_Campaign_Description       AS campaign_code
         ,CASE WHEN opportunity.ppfa_fiscal_month IS NOT NULL THEN opportunity.ppfa_fiscal_month
               WHEN opportunity.deposit_date IS NOT NULL THEN akaplan.ppfa_fiscal_month(opportunity.deposit_date):: char
               ELSE akaplan.ppfa_fiscal_month(opportunity.adjusted_deposit_date):: char
          END
         ,CASE WHEN opportunity.ppfa_fiscal_year IS NOT NULL THEN opportunity.ppfa_fiscal_year
               WHEN opportunity.deposit_date IS NOT NULL THEN akaplan.ppfa_fiscal_year(opportunity.deposit_date)
               ELSE akaplan.ppfa_fiscal_year(opportunity.adjusted_deposit_date)
          END
         ,CASE WHEN opportunity.id = (SELECT c3_first_gift_id
                                  FROM rounddata.giving_summary x
                                  WHERE x.accountid = opportunity.accountid
                                     )
               THEN 'Y'
               ELSE 'N'
          END                                              AS First_Gift_Natl_c3
         ,CASE WHEN opportunity.id = (SELECT c4_first_gift_id
                                  FROM rounddata.giving_summary x
                                  WHERE x.accountid = opportunity.accountid
                                     )
               THEN 'Y'
               ELSE 'N'
          END                                            AS First_Gift_Natl_c4
         ,a.c3_affiliate_number                          AS Donor_c3_affil_number
         ,a.c4_affiliate_number                          AS Donor_C4_affil_number
         ,CASE WHEN opportunity.adjusted ilike 'TRUE'
               THEN 'Y'
               ELSE 'N'
          END                                            AS Adjusted
         ,CASE WHEN vehicle.rc_bios__account IS NOT NULL
               THEN 'Y'
               ELSE 'N'
           END                                           AS IsGivingVehicle
         ,'HARD'                                         AS Credit_Type
         ,NULL                                           AS Giving_level_pre_gift
         ,opportunity.rC_Giving__Giving_Number           AS Giving_Number
         ,CASE WHEN recordtype.namex ilike 'Transaction'
               AND opportunity.stagename ilike 'Completed'
               THEN 1
               WHEN recordtype.namex ilike 'Pledge Payment'
               AND  opportunity.stagename  ilike 'Completed'
               AND  opportunity.rc_giving__is_bookable ilike 'FALSE'
               THEN 1
               WHEN recordtype.namex ilike 'Pledge'
               AND opportunity.stagename IN ( 'Completed','Partially Collected','Partially Complete')
               THEN 1
               ELSE 0
          END                                     AS reportable_revenue
         ,NULL                                    AS has_soft_credit
    FROM rounddata.opportunity
    JOIN rounddata.v_campaign campaign                                         ON opportunity.rc_giving__source_code = campaign.unique_source_code
    JOIN rounddata.accountx a                                                  ON a.id = opportunity.accountid
    JOIN rounddata.recordtype recordtype                                       ON opportunity.recordtypeid = recordtype.id
    LEFT JOIN rounddata.rc_giving__payment_method rc_giving__payment_method  ON opportunity.rc_giving__payment_method_sele = rc_giving__payment_method.id
    LEFT JOIN akaplan.rc_bios__preference_vehicle vehicle                    ON opportunity.accountid = vehicle.rc_bios__account
    WHERE recordtype.namex = 'Pledge'
    AND   opportunity.rc_giving__is_bookable ilike 'true'
    AND ( opportunity.delete_flag <>'Y' OR opportunity.rc_giving__archive_flag ilike 'TRUE')
    AND opportunity.RC_GIVING__CURRENT_GIVING_AMOU > 0   -- added 20190520 by cdelja to remove adjustments
    -- 20191114 cdelja changed opportunity.amount to opportunity.rc_giving__current_giving_amou per PPFA request
    -- AND opportunity.amount>0
   UNION ALL
    -- --------------------------------------------
    --
    -- Credits
    --
    -- --------------------------------------------
    SELECT rc_giving__opportunity_credit.rc_giving__opportunity_close_d
          ,CASE WHEN opportunity.Adjusted ilike'true'
                THEN opportunity.Adjusted_Deposit_Date
                WHEN opportunity.Adjusted ilike 'false'
                THEN opportunity.Deposit_Date
           END                                                                                                 deposit_date
          ,SYSDATE                                                                                            datepulled
          ,rc_giving__opportunity_credit.rC_Giving__Amount                                                     amount
          ,'CREDIT'                                                                                            data_source
          ,rc_giving__opportunity_credit.etl_id                                                                etl_id
          ,rc_giving__opportunity_credit.delete_flag                                                           delete_flag
          ,rc_giving__opportunity_credit.Affiliate_number                                                      affiliate_number
          ,NULL                                                                                                channel
          ,NULL                                                                                                payment_subtype
          ,CASE WHEN opportunity.rc_giving__is_sustainer ilike 'true'
               THEN 'offline'
               WHEN campaign.SourceCode_Campaign_Code = 'W'
               THEN 'online'
               ELSE NULL
           END                                                                                                 is_sustainer
          ,rc_giving__opportunity_credit.rC_Giving__Account                                                    ngoc_accountid
          ,rc_giving__opportunity_credit.rC_Giving__Opportunity                                                parent_transaction_id
          ,rc_giving__opportunity_credit.id                                                                    transaction_id
          ,rc_giving__opportunity_credit.createdbyid                                                           createdbyid
          ,rc_giving__opportunity_credit.lastmodifiedbyid                                                      lastmodifiedbyid
--          ,parent_opportunity.rc_giving__source_code                                                           source_code
--          ,parent_opportunity.original_source_code                                                             original_source_code
          ,opportunity.rc_giving__source_code                                                                  source_code
          ,opportunity.original_source_code                                                                    original_source_code
          ,Coalesce(opportunity.rc_giving__giving_number,opportunity.pledge_number)                       pledge_number
          ,rc_giving__opportunity_credit.rc_giving__opportunity_stage                                          stagename
          ,rc_giving__opportunity_credit.rc_giving__archive_flag                                               rc_giving__archive_flag
          ,NULL                                                                                                bookable
          ,NULL                                                                                                payment_method
          ,rc_giving__opportunity_credit.gau_code_credit                                                       gau_credit_code
          ,NULL                                                                                                gau_debit_code
          ,rc_giving__opportunity_credit.soft_credit_type                                                              recordtype
          ,CASE WHEN rc_giving__opportunity_credit.gau_code_credit IN
                 ('C325005','C325015','11000000000002340','11000000000002356','C340100TR422ONL') -- added C340100TR422ONL per case 52904
                THEN 1
                ELSE 0
           END                                                                                                         is_pass_through
          ,CASE WHEN rc_Giving__opportunity_credit.credit_close_date >= '2011-07-01'
              AND (
                    (
                      campaign.sourcecode_office_code = 'N'
                       AND 
                       (
                        rc_Giving__opportunity_credit.affiliate_number in ('090030','090330','090430','091460')
                       AND substring(rc_Giving__opportunity_credit.gau_code_credit,1,3) = 'C34'
                       AND substring(rc_Giving__opportunity_credit.gau_code_credit,8,2) = 'UR'
                       AND substring(rc_Giving__opportunity_credit.gau_code_credit,13,3) in ('AQT','RSO','MLS','ONL','PMG')
                       AND rc_Giving__opportunity_credit.nps_exclude not ilike 'True' 
                       ) 
                       OR
                       ( 
                         rc_Giving__opportunity_credit.gau_code_credit like 'C340210%' 
                       )
                    )
              OR ( campaign.sourcecode_office_code in ('L','P','E','A','W')
                   AND
                   rc_Giving__opportunity_credit.gau_code_credit like '%CFP'
                 )
              OR ( campaign.sourcecode_office_code in ('N','C')
                   AND ( rc_Giving__opportunity_credit.gau_code_credit like '_9001%'
                         OR rc_Giving__opportunity_credit.gau_code_credit like '_9002%'
                         OR rc_Giving__opportunity_credit.gau_code_credit like '_9003%'
                         OR rc_Giving__opportunity_credit.gau_code_credit like '_9004%'
                         OR rc_Giving__opportunity_credit.gau_code_credit like '_9005%')
                        )
                  OR (campaign.sourcecode_office_code in ('N','C')
                      and substring(rc_Giving__opportunity_credit.gau_code_credit,1,3) = 'C34'
                      and substring(rc_Giving__opportunity_credit.gau_code_credit,8,2) = 'UR'
                      and substring(rc_Giving__opportunity_credit.gau_code_credit,16,4) in ('A152','A113','A118','A126','A155')
                     )
                 )
              THEN 'Y'
              -- PP Keystone added 2019-07-23 cdelja per ariel
              WHEN rc_Giving__opportunity_credit.credit_close_date  >= '2019-07-01'
              AND (
                     (     campaign.sourcecode_office_code = 'N'
                       AND rc_Giving__opportunity_credit.affiliate_number = '091410'
                       AND substring(rc_Giving__opportunity_credit.gau_code_credit,1,3) = 'C34'
                       AND substring(rc_Giving__opportunity_credit.gau_code_credit,8,2) = 'UR'
                       AND substring(rc_Giving__opportunity_credit.gau_code_credit,13,3) in ('AQT','RSO','MLS','ONL','PMG')
                      )
                   OR (     campaign.sourcecode_office_code = 'K'
                        AND rc_Giving__opportunity_credit.gau_code_credit like '%CFP'
                      )
                  )
              THEN 'Y'
              WHEN (substring(rc_Giving__opportunity_credit.gau_code_credit,1,9) = 'C340600UR'
                    and
                    rc_Giving__opportunity_credit.affiliate_number in ('090030','090330','090430','091460','091410')
                   )
              OR (campaign.SourceCode_Activity_Type_Code = '3NP'
                  and
                  substring(campaign.SourceCode_Segment_Code,1,1) = 'C'
                 )
              THEN 'Y'
          /* SENFL Case 56005 */   
              WHEN rc_Giving__opportunity_credit.credit_close_date >= '2020-07-01'
              AND (
                     (     campaign.sourcecode_office_code = 'N'
                       AND rc_Giving__opportunity_credit.affiliate_number = '090320'
                       AND substring(rc_Giving__opportunity_credit.gau_code_credit,1,3) = 'C34'
                       AND substring(rc_Giving__opportunity_credit.gau_code_credit,8,2) = 'UR'
                       AND substring(rc_Giving__opportunity_credit.gau_code_credit,13,3) in ('AQT','RSO','MLS','ONL','PMG')
                      )
                   OR (     campaign.sourcecode_office_code = 'F'
                        AND rc_Giving__opportunity_credit.gau_code_credit like '%CFP'
                      )
                   OR (
                            substring(rc_Giving__opportunity_credit.gau_code_credit,1,9) = 'C340600UR'
                        and rc_Giving__opportunity_credit.affiliate_number = '090320'
                      )
                   OR (
                            campaign.SourceCode_Activity_Type_Code = '3NP'
                        and substring(Campaign.SourceCode_Segment_Code,1,1) = 'C'
                        and rc_Giving__opportunity_credit.affiliate_number = '090320')
                  )
              THEN 'Y'            
              ELSE 'N'
          END  AS cfp_shareable
         ,CASE -- WHEN SUBSTR(opportunity.rc_giving__source_code, 2,1) IN ('L','P','E','A','W')
               WHEN campaign.SourceCode_Office_Description IN ('Arizona','Illinois','Southeastern Pennsylvania','Southeast','Keystone','South East North Florida')
                    AND rc_Giving__opportunity_credit.gau_code_credit NOT LIKE '%CFP'
               THEN 'Y'
               ELSE 'N'
           END   AS is_local
         -- CASE WHEN SUBSTR(opportunity.rc_giving__source_code,1,1) = '3'
         --      THEN 'C3'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,1,1) = '4'
         --      THEN 'C4'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,1,1) = '5'
         --      THEN 'PAC'
         -- END AS entity
          ,campaign.SourceCode_Tax_Status_Description AS entity
         -- CASE WHEN SUBSTR(opportunity.rc_giving__source_code,2,1) = 'N'
         --      THEN 'PPFA'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,2,1) = 'L'
         --      THEN 'PPIL'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,2,1) = 'P'
         --      THEN 'PPSP'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,2,1) = 'A'
         --      THEN 'PPAZ'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,2,1) = 'E'
         --      THEN 'PPSE'
         -- END AS office
         ,campaign.sourceCode_Office_description AS office
         -- SUBSTR(opportunity.rc_giving__source_code,3,1) AS business_unit
         ,campaign.sourceCode_Business_Unit_Description    AS business_unit
         -- CASE WHEN SUBSTR(opportunity.rc_giving__source_code,4,1) = 'L'
         --      THEN 'Low'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,4,1) = 'D'
         --      THEN 'Mid'
         --      WHEN SUBSTR(opportunity.rc_giving__source_code,4,1) = 'M'
         --      THEN 'Major'
         -- END AS group_code
          ,campaign.sourceCode_Activity_Group_Description AS group_code
         -- SUBSTR(opportunity.rc_giving__source_code,5,1) AS campaign_code
         ,campaign.sourceCode_Campaign_Description       AS campaign_code
--          ,parent_opportunity.ppfa_fiscal_month                                                                 fiscal_month
--          ,parent_opportunity.ppfa_fiscal_year                                                                  fiscal_year
          ,opportunity.ppfa_fiscal_month                                                                 fiscal_month
          ,opportunity.ppfa_fiscal_year                                                                  fiscal_year
          ,CASE WHEN opportunity.id = (SELECT c4_first_gift_id
                                  FROM rounddata.giving_summary x
                                  WHERE x.accountid = rc_giving__opportunity_credit.rC_Giving__Account
                                      )
                THEN 'Y'
                ELSE 'N'
           END                                              AS First_Gift_Natl_c3
          ,CASE WHEN opportunity.id = (SELECT c4_first_gift_id
                                  FROM rounddata.giving_summary x
                                  WHERE x.accountid = rc_giving__opportunity_credit.rC_Giving__Account

                                      )
                THEN 'Y'
                ELSE 'N'
           END                                                                          AS First_Gift_Natl_c4
          ,a.c3_affiliate_number                                                        AS Donor_c3_affil_number
          ,a.c4_affiliate_number                                                        AS Donor_C4_affil_number
          ,NULL                                                                         AS Adjusted
          ,CASE WHEN vehicle.rc_bios__account IS NOT NULL
                THEN 'Y'
                ELSE 'N'
           END                                                                         AS IsGivingVehicle
          ,SUBSTRING(rc_giving__opportunity_credit.soft_credit_type,1,2)                  AS Credit_Type
          ,NULL                                                                        AS Giving_level_pre_gift
          ,opportunity.rC_Giving__Giving_Number                                        AS Giving_Number
          ,0                                                                           AS reportable_revenue
          ,NULL                                                                        AS has_soft_credit
    FROM rounddata.rc_giving__opportunity_credit
    JOIN rounddata.opportunity opportunity                                     ON rc_giving__opportunity = opportunity.id
--    LEFT JOIN ppfa_prod.opportunity parent_opportunity                         ON opportunity.rc_giving__parent = parent_opportunity.id
    JOIN rounddata.v_campaign campaign                                                       ON opportunity.rc_giving__source_code = campaign.unique_source_code
    JOIN rounddata.accountx      a                                                           ON rc_giving__opportunity_credit.rc_giving__account = a.id
    LEFT JOIN akaplan.rc_bios__preference_vehicle vehicle                                  ON opportunity.accountid = vehicle.rc_bios__account
  );
 
 
 --add ppid 6/15/20
 alter table rounddata.supreme_reporting_table add column ppid varchar(30);
 update rounddata.supreme_reporting_table
set ppid = resolved_id
from (select resolved_id, c.accountid from idres_analytics.current_customer_graph idr join rounddata.contact c on idr.source_primary_key = c.id) j
where j.accountid = rounddata.supreme_reporting_table.ngoc_accountid;
 
 -- Creates Backup
 drop table if exists rounddata.supreme_reporting_table_backup;
 create table rounddata.supreme_reporting_table_backup as 
 (select * from rounddata.supreme_reporting_table);
  
  -- drop table if exists rounddata.ak_supreme_reporting_table;
  -- create table rounddata.ak_supreme_reporting_table as (select * from akaplan.supreme_reporting_table);