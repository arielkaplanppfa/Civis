Drop table if exists ppfa_golden.high_touch; 
create table ppfa_golden.high_touch as 
with temp as ( /*might want to break giving levels out into its own temp table and choose the highest and then union back to the rest*/
 select distinct i.resolved_id as "ppid",'Giving Level' as "Category", a.current_giving_level as "High_Touch" 
 from ppfa_golden.current_customer_graph i 
 join rounddata.contact c on i.source_primary_key = c.id 
 join rounddata.accountx a on c.accountid = a.id
 where a.current_giving_level in ('Major Donor', 'Mid-Level VIP', 'Mid-Level High')
 UNION -- Managed Acccounts
 select distinct i.resolved_id as "ppid", p.rc_bios__subcategory as "Category", p.rc_bios__type as "High_Touch"
 from ppfa_golden.current_customer_graph i 
 join rounddata.contact c on i.source_primary_key = c.id 
 join rounddata.rc_bios__preference p on c.accountid = p.rc_bios__account
 where p.rc_bios__active = 'true' and p.rc_bios__type like '%Managed%'
 UNION -- High Touch Portfolio Prefs
 select distinct i.resolved_id as "ppid", p.rc_bios__subcategory as "Category", p.rc_bios__type as "High_Touch"
 from ppfa_golden.current_customer_graph i 
 join rounddata.contact c on i.source_primary_key = c.id 
 join rounddata.rc_bios__preference p on c.accountid = p.rc_bios__account
 where p.rc_bios__active = 'true' and p.rc_bios__subcategory = 'High Touch Portfolio'
 UNION -- Prospect Management Prefs
 select distinct i.resolved_id as "ppid", p.rc_bios__subcategory as "Category", p.rc_bios__type as "High_Touch"
 from ppfa_golden.current_customer_graph i 
 join rounddata.contact c on i.source_primary_key = c.id 
 join rounddata.rc_bios__preference p on c.accountid = p.rc_bios__account
 where p.rc_bios__active = 'true' and p.rc_bios__subcategory = 'Prospect Management'
 UNION -- Celebrity Prefs
 select distinct i.resolved_id as "ppid", p.rc_bios__category as "Category", p.rc_bios__subcategory as "High_Touch"
 from ppfa_golden.current_customer_graph i 
 join rounddata.contact c on i.source_primary_key = c.id 
 join rounddata.rc_bios__preference p on c.accountid = p.rc_bios__account
 where p.rc_bios__active = 'true' and p.rc_bios__subcategory = 'Celebrity'
 UNION -- Board Member Prefs
 select distinct i.resolved_id as "ppid", p.rc_bios__subcategory as "Category", p.rc_bios__type as "High_Touch"
 from ppfa_golden.current_customer_graph i 
 join rounddata.contact c on i.source_primary_key = c.id 
 join rounddata.rc_bios__preference p on c.accountid = p.rc_bios__account
 where p.rc_bios__active = 'true' and p.rc_bios__subcategory = 'Board Member'
 UNION -- Prospect Managers
 select distinct i.resolved_id as "ppid",'Prospect Manager' as "Category", pm.namex as "High_Touch" 
 from ppfa_golden.current_customer_graph i 
 join rounddata.contact c on i.source_primary_key = c.id 
 join rounddata.accountx a on c.accountid = a.id
 join rounddata.contact pm on a.current_prospect_manager = pm.id
 where a.current_prospect_manager is not null
 ),
 temptwo as (
 select distinct ppid from temp
 )
 select w.ppid, listagg( distinct g.high_touch, '; ') as "Giving_Level", c.high_touch as "Corporations", f.high_touch as "Foundation", listagg(distinct p.high_touch, '; ') as "Portfolio", l.high_touch as "Planned_Giving", listagg(distinct m.high_touch, '; ') as "Prospect_management", b.high_touch as "Celebrity", listagg(distinct bm.high_touch, '; ') as "Board_Member", listagg(distinct pm.high_touch, '; ') as "Prospect_managers"  
 from temptwo w
 left join ( select t.ppid, high_touch from temp t where category = 'Giving Level' ) g on w.ppid = g.ppid /* Giving Levels */
 left join ( select c.ppid, high_touch from temp c where category = 'Corporations' ) c on w.ppid = c.ppid  /* Corporations */
 left join ( select f.ppid, high_touch from temp f where category = 'Foundation' ) f on w.ppid = f.ppid  /* Foundations */
 left join ( select p.ppid, high_touch from temp p where category = 'High Touch Portfolio' ) p on w.ppid = p.ppid  /* Portfolio */
 left join ( select l.ppid, high_touch from temp l where category = 'Planned Gift' ) l on w.ppid = l.ppid  /* PG */
 left join ( select m.ppid, high_touch from temp m where category = 'Prospect Management' ) m on w.ppid = m.ppid /*Prospect Management*/
 left join ( select b.ppid, high_touch from temp b where high_touch = 'Celebrity' ) b on w.ppid = b.ppid /*Celebrity*/
 left join ( select bm.ppid, high_touch from temp bm where category = 'Board Member' ) bm on w.ppid = bm.ppid /*Board Member*/
 left join ( select pm.ppid, high_touch from temp pm where category = 'Prospect Manager' ) pm on w.ppid = pm.ppid /*prospect Managers*/
 group by  w.ppid, c.high_touch,  f.high_touch, l.high_touch, b.high_touch
 