create or replace procedure akaplan.tealium_rename(tablename varchar) 

LANGUAGE plpgsql

as $$

declare col_count integer ;

declare old varchar ;
declare new varchar ;
declare tbl varchar := tablename;

begin

 <<tealium_rename>>

LOOP

-- FIugre out how to check for 0 columns

old = quote_ident( (select column_name from information_schema.columns where table_schema = 'tealium_staging' and table_name = quote_ident(tbl) 
       and ( column_name like '% %' or column_name like '%-%' or column_name like '%)%' or column_name like '%(%' ) limit 1) );

new = replace(replace(replace(replace(replace(replace(old,'-','_'),' - ', '_'),' ','_'),')',''),'(',''),'.','_') ;

Execute 'Alter table tealium_staging."'||quote_ident(tbl)||'" rename column '||old||' to '||new ;



col_count:= (select count(*):: int from information_schema.columns where table_schema = 'tealium_staging' and table_name = tablename 
                               and ( column_name like '% %' or column_name like '%-%' or column_name like '%)%' or column_name like '%(%' or column_name like '%.%' or column_name like '% %') );


EXIT tealium_rename WHEN (col_count  =  0);


END LOOP;



END;

$$;